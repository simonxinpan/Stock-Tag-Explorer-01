# 集成式热力图体验 - 技术架构设计

**文档版本**: v1.0  
**负责人**: PM-Core  
**创建日期**: 2025年1月30日  
**关联文档**: 集成式热力图体验-PRD.md

---

## 1. 系统架构概览

### 1.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                    Stock Tag Explorer 主应用                 │
├─────────────────────────────────────────────────────────────┤
│  标签广场        │  趋势榜单        │  热力图中心        │
│  (index.html)   │  (trending.html) │  (heatmap-center) │
│                 │                 │                   │
│  ┌─────────────┐ │  ┌─────────────┐ │  ┌─────────────┐  │
│  │ 标签详情页   │ │  │ 榜单热力图   │ │  │ 汇总导航     │  │
│  │ + 热力图    │ │  │ (迷你版)    │ │  │ + 全景链接   │  │
│  └─────────────┘ │  └─────────────┘ │  └─────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   StockHeatmap 核心组件                      │
├─────────────────────────────────────────────────────────────┤
│  数据处理器      │  渲染引擎        │  交互控制器        │
│  DataProcessor  │  HeatmapRenderer │  InteractionHandler │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      现有API层                              │
├─────────────────────────────────────────────────────────────┤
│  /api/stocks-by-tag  │  /api/trending  │  /api/tags        │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心设计原则
- **组件化**: 热力图功能封装为可复用组件
- **渐进增强**: 在现有功能基础上增加热力图，不破坏原有体验
- **性能优先**: 优化渲染性能，支持多实例并存
- **数据驱动**: 基于现有API数据，无需额外后端开发

---

## 2. 核心组件设计

### 2.1 StockHeatmap 主组件

#### 组件接口设计
```javascript
class StockHeatmap {
  constructor(options) {
    this.container = options.container;     // DOM容器选择器
    this.data = options.data || [];         // 股票数据数组
    this.config = {
      width: options.width || 'auto',       // 宽度
      height: options.height || 400,        // 高度
      colorScheme: options.colorScheme || 'redGreen', // 颜色方案
      showLabels: options.showLabels !== false,       // 显示标签
      interactive: options.interactive !== false,     // 交互功能
      groupBy: options.groupBy || 'sector',           // 分组方式
      ...options.config
    };
    this.callbacks = options.callbacks || {}; // 事件回调
  }

  // 核心方法
  render() { /* 渲染热力图 */ }
  update(newData) { /* 更新数据 */ }
  resize() { /* 响应式调整 */ }
  destroy() { /* 销毁实例 */ }
}
```

#### 使用示例
```javascript
// 标签详情页使用
const tagHeatmap = new StockHeatmap({
  container: '#tag-heatmap',
  data: stocksData,
  config: {
    height: 400,
    groupBy: 'sector',
    showLabels: true
  },
  callbacks: {
    onStockClick: (stock) => {
      window.open(`/stock-detail.html?symbol=${stock.symbol}`);
    },
    onSectorClick: (sector) => {
      window.location.href = `/tag-detail.html?tagId=sector_${sector}`;
    }
  }
});

// 趋势榜单迷你热力图
const miniHeatmap = new StockHeatmap({
  container: '#trending-mini-heatmap',
  data: trendingStocks,
  config: {
    height: 200,
    showLabels: false,
    groupBy: 'none' // 不分组，直接显示股票
  }
});
```

### 2.2 HeatmapRenderer 渲染引擎

#### 职责
- 将处理后的数据转换为可视化元素
- 管理SVG/Canvas渲染逻辑
- 处理颜色映射和尺寸计算
- 实现动画和过渡效果

#### 核心算法
```javascript
class HeatmapRenderer {
  constructor(container, config) {
    this.container = container;
    this.config = config;
    this.svg = null;
  }

  // Treemap布局算法
  calculateLayout(data) {
    // 使用D3.js treemap算法或自定义实现
    return d3.treemap()
      .size([this.config.width, this.config.height])
      .padding(2)
      (d3.hierarchy(data).sum(d => d.market_cap));
  }

  // 颜色映射
  getColor(changePercent) {
    const scale = d3.scaleLinear()
      .domain([-10, 0, 10])
      .range(['#ff4444', '#ffffff', '#44ff44']);
    return scale(changePercent);
  }

  // 渲染方法
  render(layoutData) {
    // SVG渲染逻辑
    this.svg = d3.select(this.container)
      .append('svg')
      .attr('width', this.config.width)
      .attr('height', this.config.height);

    // 绘制矩形和文本
    this.drawRectangles(layoutData);
    this.drawLabels(layoutData);
  }
}
```

### 2.3 DataProcessor 数据处理器

#### 职责
- 将API返回的股票数据转换为热力图所需格式
- 实现数据分组和层次结构构建
- 处理数据验证和异常情况

#### 数据转换流程
```javascript
class DataProcessor {
  // 主处理方法
  static processStockData(rawData, groupBy = 'sector') {
    // 1. 数据验证和清洗
    const cleanData = this.validateAndClean(rawData);
    
    // 2. 根据分组方式构建层次结构
    const hierarchyData = this.buildHierarchy(cleanData, groupBy);
    
    // 3. 计算聚合指标
    const enrichedData = this.calculateAggregates(hierarchyData);
    
    return enrichedData;
  }

  // 构建层次结构
  static buildHierarchy(data, groupBy) {
    if (groupBy === 'none') {
      // 不分组，直接返回扁平结构
      return {
        name: 'root',
        children: data.map(stock => ({
          name: stock.symbol,
          value: stock.market_cap,
          change: stock.change_percent,
          data: stock
        }))
      };
    }

    // 按行业分组
    const grouped = d3.group(data, d => d.sector || '其他');
    return {
      name: 'root',
      children: Array.from(grouped, ([sector, stocks]) => ({
        name: sector,
        children: stocks.map(stock => ({
          name: stock.symbol,
          value: stock.market_cap,
          change: stock.change_percent,
          data: stock
        }))
      }))
    };
  }
}
```

---

## 3. 集成方案设计

### 3.1 标签详情页集成

#### 文件修改清单
- `public/tag-detail.html`: 添加热力图容器
- `public/scripts/tag-detail.js`: 集成热力图组件调用
- `public/styles/tag-detail.css`: 添加热力图样式

#### 集成代码示例
```html
<!-- tag-detail.html 修改 -->
<div class="tag-content">
  <!-- 新增热力图容器 -->
  <div class="heatmap-section">
    <h3>板块热力图</h3>
    <div id="tag-heatmap" class="heatmap-container"></div>
  </div>
  
  <!-- 原有股票列表 -->
  <div class="stocks-section">
    <h3>股票列表</h3>
    <div id="stocks-container"></div>
  </div>
</div>
```

```javascript
// tag-detail.js 修改
class TagDetailPage {
  async loadTagData(tagId) {
    try {
      const response = await fetch(`/api/stocks-by-tag?tag=${tagId}`);
      const data = await response.json();
      
      // 渲染股票列表（原有逻辑）
      this.renderStocksList(data.stocks);
      
      // 新增：渲染热力图
      this.renderHeatmap(data.stocks);
      
    } catch (error) {
      console.error('加载数据失败:', error);
    }
  }

  renderHeatmap(stocks) {
    // 创建热力图实例
    this.heatmap = new StockHeatmap({
      container: '#tag-heatmap',
      data: stocks,
      config: {
        height: 400,
        groupBy: 'sector'
      },
      callbacks: {
        onStockClick: (stock) => {
          window.open(`/stock-detail.html?symbol=${stock.symbol}`);
        }
      }
    });
  }
}
```

### 3.2 趋势榜单页集成

#### 集成策略
- 在每个榜单卡片中嵌入迷你热力图
- 使用懒加载优化性能
- 实现热力图与榜单数据的同步

```javascript
// trending.js 修改
class TrendingPage {
  renderRankingCard(ranking, container) {
    const cardHTML = `
      <div class="ranking-card">
        <h3>${ranking.title}</h3>
        
        <!-- 新增迷你热力图 -->
        <div class="mini-heatmap-container" 
             id="heatmap-${ranking.id}"></div>
        
        <!-- 原有股票列表 -->
        <div class="stocks-list">
          ${this.renderStocksList(ranking.stocks)}
        </div>
      </div>
    `;
    
    container.innerHTML = cardHTML;
    
    // 渲染迷你热力图
    this.renderMiniHeatmap(ranking.stocks, `#heatmap-${ranking.id}`);
  }

  renderMiniHeatmap(stocks, container) {
    new StockHeatmap({
      container: container,
      data: stocks,
      config: {
        height: 150,
        showLabels: false,
        groupBy: 'none'
      }
    });
  }
}
```

### 3.3 热力图中心页面

#### 页面结构设计
```html
<!-- heatmap-center.html -->
<!DOCTYPE html>
<html>
<head>
  <title>热力图中心 - Stock Tag Explorer</title>
  <link rel="stylesheet" href="styles/heatmap-center.css">
</head>
<body>
  <div class="heatmap-center">
    <header>
      <h1>📊 热力图中心</h1>
      <p>探索不同维度的市场热力图视图</p>
    </header>

    <main>
      <!-- 全景热力图 -->
      <section class="heatmap-category">
        <h2>🌍 全景热力图</h2>
        <div class="heatmap-grid">
          <a href="https://heatmap-dvrckt4gd-simon-pans-projects.vercel.app/" 
             class="heatmap-card featured">
            <h3>完整市场热力图</h3>
            <p>查看所有股票的完整热力图视图</p>
          </a>
        </div>
      </section>

      <!-- 行业热力图 -->
      <section class="heatmap-category">
        <h2>🏭 行业热力图</h2>
        <div class="heatmap-grid" id="sector-heatmaps"></div>
      </section>

      <!-- 标签热力图 -->
      <section class="heatmap-category">
        <h2>🏷️ 标签热力图</h2>
        <div class="heatmap-grid" id="tag-heatmaps"></div>
      </section>

      <!-- 榜单热力图 -->
      <section class="heatmap-category">
        <h2>📈 榜单热力图</h2>
        <div class="heatmap-grid" id="ranking-heatmaps"></div>
      </section>
    </main>
  </div>

  <script src="scripts/heatmap-center.js"></script>
</body>
</html>
```

---

## 4. 性能优化策略

### 4.1 渲染性能优化

#### 懒加载机制
```javascript
class LazyHeatmapLoader {
  constructor() {
    this.observer = new IntersectionObserver(
      this.handleIntersection.bind(this),
      { threshold: 0.1 }
    );
  }

  observe(element) {
    this.observer.observe(element);
  }

  handleIntersection(entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        this.loadHeatmap(entry.target);
        this.observer.unobserve(entry.target);
      }
    });
  }

  loadHeatmap(container) {
    const config = JSON.parse(container.dataset.heatmapConfig);
    new StockHeatmap(config);
  }
}
```

#### 组件复用池
```javascript
class HeatmapPool {
  constructor(maxSize = 5) {
    this.pool = [];
    this.maxSize = maxSize;
  }

  acquire(config) {
    if (this.pool.length > 0) {
      const instance = this.pool.pop();
      instance.reconfigure(config);
      return instance;
    }
    return new StockHeatmap(config);
  }

  release(instance) {
    if (this.pool.length < this.maxSize) {
      instance.clear();
      this.pool.push(instance);
    } else {
      instance.destroy();
    }
  }
}
```

### 4.2 数据缓存策略

```javascript
class DataCache {
  constructor(ttl = 5 * 60 * 1000) { // 5分钟TTL
    this.cache = new Map();
    this.ttl = ttl;
  }

  get(key) {
    const item = this.cache.get(key);
    if (!item) return null;
    
    if (Date.now() - item.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return item.data;
  }

  set(key, data) {
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }
}
```

---

## 5. 错误处理与监控

### 5.1 错误处理机制

```javascript
class HeatmapErrorHandler {
  static handleRenderError(error, container) {
    console.error('热力图渲染失败:', error);
    
    // 显示友好的错误信息
    container.innerHTML = `
      <div class="heatmap-error">
        <p>📊 热力图暂时无法显示</p>
        <button onclick="location.reload()">重试</button>
      </div>
    `;
    
    // 发送错误报告
    this.reportError(error);
  }

  static reportError(error) {
    // 发送到监控系统
    if (window.analytics) {
      window.analytics.track('Heatmap Error', {
        error: error.message,
        stack: error.stack,
        timestamp: new Date().toISOString()
      });
    }
  }
}
```

### 5.2 性能监控

```javascript
class PerformanceMonitor {
  static measureRenderTime(heatmapId, renderFunction) {
    const startTime = performance.now();
    
    return renderFunction().then(result => {
      const endTime = performance.now();
      const renderTime = endTime - startTime;
      
      // 记录性能指标
      this.recordMetric('heatmap_render_time', renderTime, {
        heatmapId,
        timestamp: Date.now()
      });
      
      return result;
    });
  }

  static recordMetric(name, value, metadata) {
    if (window.analytics) {
      window.analytics.track('Performance Metric', {
        metric: name,
        value,
        ...metadata
      });
    }
  }
}
```

---

## 6. 部署与发布策略

### 6.1 渐进式发布

1. **阶段1**: 仅在标签详情页启用热力图
2. **阶段2**: 在趋势榜单页添加迷你热力图
3. **阶段3**: 发布热力图中心页面
4. **阶段4**: 启用所有交互功能

### 6.2 功能开关

```javascript
const FeatureFlags = {
  HEATMAP_IN_TAG_DETAIL: true,
  HEATMAP_IN_TRENDING: false,
  HEATMAP_CENTER_PAGE: false,
  HEATMAP_INTERACTIONS: false
};

// 使用示例
if (FeatureFlags.HEATMAP_IN_TAG_DETAIL) {
  this.renderHeatmap(stocks);
}
```

### 6.3 回滚策略

- 保持原有功能完全独立
- 热力图组件异常不影响主要功能
- 提供一键禁用热力图的开关

---

## 7. 测试策略

### 7.1 单元测试

```javascript
// 测试数据处理器
describe('DataProcessor', () => {
  test('should process stock data correctly', () => {
    const rawData = [/* 测试数据 */];
    const processed = DataProcessor.processStockData(rawData);
    
    expect(processed).toHaveProperty('name', 'root');
    expect(processed.children).toHaveLength(/* 期望长度 */);
  });
});

// 测试热力图组件
describe('StockHeatmap', () => {
  test('should render without errors', () => {
    const container = document.createElement('div');
    const heatmap = new StockHeatmap({
      container,
      data: mockStockData
    });
    
    expect(() => heatmap.render()).not.toThrow();
  });
});
```

### 7.2 集成测试

```javascript
// 测试页面集成
describe('Tag Detail Page Integration', () => {
  test('should load heatmap when stocks data is available', async () => {
    // 模拟API响应
    fetchMock.mockResponseOnce(JSON.stringify({
      stocks: mockStockData
    }));
    
    const page = new TagDetailPage();
    await page.loadTagData('test-tag');
    
    // 验证热力图是否渲染
    const heatmapContainer = document.querySelector('#tag-heatmap');
    expect(heatmapContainer.children.length).toBeGreaterThan(0);
  });
});
```

### 7.3 性能测试

```javascript
// 性能基准测试
describe('Performance Tests', () => {
  test('heatmap should render within 500ms', async () => {
    const startTime = performance.now();
    
    const heatmap = new StockHeatmap({
      container: '#test-container',
      data: largeStockDataset
    });
    
    await heatmap.render();
    
    const endTime = performance.now();
    expect(endTime - startTime).toBeLessThan(500);
  });
});
```

---

## 8. 维护与扩展

### 8.1 代码组织结构

```
public/
├── js/
│   ├── heatmap/
│   │   ├── StockHeatmap.js          # 主组件
│   │   ├── HeatmapRenderer.js       # 渲染引擎
│   │   ├── DataProcessor.js         # 数据处理
│   │   ├── InteractionHandler.js    # 交互控制
│   │   └── utils.js                 # 工具函数
│   ├── pages/
│   │   ├── tag-detail-enhanced.js   # 增强的标签详情页
│   │   ├── trending-enhanced.js     # 增强的趋势榜单页
│   │   └── heatmap-center.js        # 热力图中心页
│   └── shared/
│       ├── FeatureFlags.js          # 功能开关
│       ├── ErrorHandler.js          # 错误处理
│       └── PerformanceMonitor.js    # 性能监控
├── styles/
│   ├── heatmap/
│   │   ├── heatmap-core.css         # 核心样式
│   │   ├── heatmap-responsive.css   # 响应式样式
│   │   └── heatmap-themes.css       # 主题样式
│   └── pages/
│       ├── tag-detail-enhanced.css
│       ├── trending-enhanced.css
│       └── heatmap-center.css
└── heatmap-center.html              # 热力图中心页面
```

### 8.2 扩展接口设计

```javascript
// 插件系统
class HeatmapPlugin {
  constructor(name, config) {
    this.name = name;
    this.config = config;
  }

  // 生命周期钩子
  beforeRender(data) { return data; }
  afterRender(element) { /* 后处理 */ }
  onInteraction(event) { /* 交互处理 */ }
}

// 主题系统
class HeatmapTheme {
  constructor(name, colors, styles) {
    this.name = name;
    this.colors = colors;
    this.styles = styles;
  }

  apply(renderer) {
    renderer.setColorScheme(this.colors);
    renderer.setStyles(this.styles);
  }
}
```

---

**文档状态**: ✅ 已完成  
**下一步**: 开始开发实施指南编写