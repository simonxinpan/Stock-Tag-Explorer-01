# é›†æˆå¼çƒ­åŠ›å›¾ä½“éªŒ - å¼€å‘å®æ–½æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**è´Ÿè´£äºº**: PM-Core  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ30æ—¥  
**å…³è”æ–‡æ¡£**: é›†æˆå¼çƒ­åŠ›å›¾ä½“éªŒ-PRD.md, æŠ€æœ¯æ¶æ„è®¾è®¡.md

---

## 1. å¼€å‘ä»»åŠ¡æ¸…å•

### Phase 1: æ ¸å¿ƒç»„ä»¶å¼€å‘ (P0)

#### ä»»åŠ¡ 1.1: é‡æ„çƒ­åŠ›å›¾ç»„ä»¶ â­â­â­
**é¢„ä¼°æ—¶é—´**: 2å¤©  
**è´Ÿè´£äºº**: å‰ç«¯å¼€å‘  
**ä¾èµ–**: æ— 

**å­ä»»åŠ¡**:
- [ ] åˆ›å»º `StockHeatmap.js` ä¸»ç»„ä»¶ç±»
- [ ] å®ç° `DataProcessor.js` æ•°æ®å¤„ç†æ¨¡å—
- [ ] å®ç° `HeatmapRenderer.js` æ¸²æŸ“å¼•æ“
- [ ] åˆ›å»º `heatmap-core.css` æ ·å¼æ–‡ä»¶
- [ ] ç¼–å†™ç»„ä»¶å•å…ƒæµ‹è¯•

#### ä»»åŠ¡ 1.2: æ ‡ç­¾è¯¦æƒ…é¡µé›†æˆ â­â­â­
**é¢„ä¼°æ—¶é—´**: 1.5å¤©  
**è´Ÿè´£äºº**: å‰ç«¯å¼€å‘  
**ä¾èµ–**: ä»»åŠ¡ 1.1

**å­ä»»åŠ¡**:
- [ ] ä¿®æ”¹ `tag-detail.html` æ·»åŠ çƒ­åŠ›å›¾å®¹å™¨
- [ ] æ›´æ–° `tag-detail.js` é›†æˆçƒ­åŠ›å›¾ç»„ä»¶
- [ ] æ›´æ–° `tag-detail.css` æ·»åŠ çƒ­åŠ›å›¾æ ·å¼
- [ ] æµ‹è¯•ä¸åŒæ ‡ç­¾çš„çƒ­åŠ›å›¾æ˜¾ç¤º
- [ ] éªŒè¯å“åº”å¼å¸ƒå±€

#### ä»»åŠ¡ 1.3: è¶‹åŠ¿æ¦œå•é¡µé›†æˆ â­â­
**é¢„ä¼°æ—¶é—´**: 2å¤©  
**è´Ÿè´£äºº**: å‰ç«¯å¼€å‘  
**ä¾èµ–**: ä»»åŠ¡ 1.1

**å­ä»»åŠ¡**:
- [ ] ä¿®æ”¹ `trending.html` æ·»åŠ è¿·ä½ çƒ­åŠ›å›¾å®¹å™¨
- [ ] æ›´æ–° `trending.js` é›†æˆè¿·ä½ çƒ­åŠ›å›¾
- [ ] å®ç°æ‡’åŠ è½½æœºåˆ¶ä¼˜åŒ–æ€§èƒ½
- [ ] æµ‹è¯•å¤šä¸ªçƒ­åŠ›å›¾åŒæ—¶æ¸²æŸ“
- [ ] ä¼˜åŒ–è¿·ä½ çƒ­åŠ›å›¾çš„ä¿¡æ¯å¯†åº¦

### Phase 2: åŠŸèƒ½å¢å¼º (P1)

#### ä»»åŠ¡ 2.1: çƒ­åŠ›å›¾äº¤äº’åŠŸèƒ½ â­â­
**é¢„ä¼°æ—¶é—´**: 1å¤©  
**è´Ÿè´£äºº**: å‰ç«¯å¼€å‘  
**ä¾èµ–**: Phase 1 å®Œæˆ

**å­ä»»åŠ¡**:
- [ ] å®ç°è‚¡ç¥¨ç‚¹å‡»è·³è½¬åŠŸèƒ½
- [ ] å®ç°è¡Œä¸šæ¿å—ç‚¹å‡»è·³è½¬
- [ ] æ·»åŠ hoveræç¤ºæ•ˆæœ
- [ ] æµ‹è¯•è·³è½¬é“¾æ¥çš„æ­£ç¡®æ€§

#### ä»»åŠ¡ 2.2: çƒ­åŠ›å›¾ä¸­å¿ƒé¡µé¢ â­
**é¢„ä¼°æ—¶é—´**: 1.5å¤©  
**è´Ÿè´£äºº**: å‰ç«¯å¼€å‘  
**ä¾èµ–**: ä»»åŠ¡ 2.1

**å­ä»»åŠ¡**:
- [ ] åˆ›å»º `heatmap-center.html` é¡µé¢
- [ ] å®ç° `heatmap-center.js` é€»è¾‘
- [ ] åˆ›å»º `heatmap-center.css` æ ·å¼
- [ ] åŠ¨æ€ç”Ÿæˆè¡Œä¸šå’Œæ ‡ç­¾é“¾æ¥
- [ ] æµ‹è¯•æ‰€æœ‰é“¾æ¥çš„å¯ç”¨æ€§

#### ä»»åŠ¡ 2.3: æ€§èƒ½ä¼˜åŒ– â­â­
**é¢„ä¼°æ—¶é—´**: 1å¤©  
**è´Ÿè´£äºº**: å‰ç«¯å¼€å‘  
**ä¾èµ–**: Phase 1 å®Œæˆ

**å­ä»»åŠ¡**:
- [ ] å®ç°ç»„ä»¶å¤ç”¨æ± 
- [ ] æ·»åŠ æ•°æ®ç¼“å­˜æœºåˆ¶
- [ ] ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§
- [ ] è¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•

---

## 2. è¯¦ç»†å®æ–½æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»ºçƒ­åŠ›å›¾æ ¸å¿ƒç»„ä»¶

#### 1.1 åˆ›å»º StockHeatmap.js

**æ–‡ä»¶è·¯å¾„**: `public/js/heatmap/StockHeatmap.js`

```javascript
/**
 * è‚¡ç¥¨çƒ­åŠ›å›¾ç»„ä»¶
 * æ”¯æŒå¤šç§é…ç½®å’Œäº¤äº’æ¨¡å¼
 */
class StockHeatmap {
  constructor(options = {}) {
    // éªŒè¯å¿…éœ€å‚æ•°
    if (!options.container) {
      throw new Error('å®¹å™¨é€‰æ‹©å™¨æ˜¯å¿…éœ€çš„');
    }

    this.container = typeof options.container === 'string' 
      ? document.querySelector(options.container)
      : options.container;
    
    if (!this.container) {
      throw new Error('æ‰¾ä¸åˆ°æŒ‡å®šçš„å®¹å™¨å…ƒç´ ');
    }

    this.data = options.data || [];
    this.config = this.mergeConfig(options.config || {});
    this.callbacks = options.callbacks || {};
    
    // å†…éƒ¨çŠ¶æ€
    this.rendered = false;
    this.resizeObserver = null;
    
    // åˆå§‹åŒ–ç»„ä»¶
    this.init();
  }

  /**
   * åˆå¹¶é»˜è®¤é…ç½®
   */
  mergeConfig(userConfig) {
    const defaultConfig = {
      width: 'auto',
      height: 400,
      colorScheme: 'redGreen',
      showLabels: true,
      interactive: true,
      groupBy: 'sector',
      minRectSize: 10,
      padding: 2,
      animationDuration: 300
    };
    
    return { ...defaultConfig, ...userConfig };
  }

  /**
   * åˆå§‹åŒ–ç»„ä»¶
   */
  init() {
    this.setupContainer();
    this.setupResizeObserver();
    
    if (this.data.length > 0) {
      this.render();
    }
  }

  /**
   * è®¾ç½®å®¹å™¨
   */
  setupContainer() {
    this.container.classList.add('stock-heatmap');
    this.container.innerHTML = '';
    
    // è®¾ç½®å®¹å™¨æ ·å¼
    if (this.config.width !== 'auto') {
      this.container.style.width = this.config.width + 'px';
    }
    this.container.style.height = this.config.height + 'px';
  }

  /**
   * è®¾ç½®å“åº”å¼ç›‘å¬
   */
  setupResizeObserver() {
    if (window.ResizeObserver) {
      this.resizeObserver = new ResizeObserver(() => {
        if (this.rendered) {
          this.resize();
        }
      });
      this.resizeObserver.observe(this.container);
    }
  }

  /**
   * æ¸²æŸ“çƒ­åŠ›å›¾
   */
  async render() {
    try {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      this.showLoading();
      
      // å¤„ç†æ•°æ®
      const processedData = DataProcessor.processStockData(
        this.data, 
        this.config.groupBy
      );
      
      // åˆ›å»ºæ¸²æŸ“å™¨
      this.renderer = new HeatmapRenderer(this.container, this.config);
      
      // æ¸²æŸ“
      await this.renderer.render(processedData);
      
      // è®¾ç½®äº¤äº’
      if (this.config.interactive) {
        this.setupInteractions();
      }
      
      this.rendered = true;
      this.hideLoading();
      
      // è§¦å‘æ¸²æŸ“å®Œæˆå›è°ƒ
      if (this.callbacks.onRenderComplete) {
        this.callbacks.onRenderComplete(this);
      }
      
    } catch (error) {
      this.handleError(error);
    }
  }

  /**
   * æ›´æ–°æ•°æ®
   */
  update(newData) {
    this.data = newData;
    if (this.rendered) {
      this.render();
    }
  }

  /**
   * å“åº”å¼è°ƒæ•´
   */
  resize() {
    if (this.renderer) {
      this.renderer.resize();
    }
  }

  /**
   * è®¾ç½®äº¤äº’äº‹ä»¶
   */
  setupInteractions() {
    this.container.addEventListener('click', (event) => {
      const target = event.target.closest('[data-stock], [data-sector]');
      if (!target) return;
      
      if (target.dataset.stock) {
        this.handleStockClick(JSON.parse(target.dataset.stock));
      } else if (target.dataset.sector) {
        this.handleSectorClick(target.dataset.sector);
      }
    });
    
    // Hover æ•ˆæœ
    this.container.addEventListener('mouseover', (event) => {
      const target = event.target.closest('[data-stock], [data-sector]');
      if (target) {
        target.classList.add('heatmap-hover');
      }
    });
    
    this.container.addEventListener('mouseout', (event) => {
      const target = event.target.closest('[data-stock], [data-sector]');
      if (target) {
        target.classList.remove('heatmap-hover');
      }
    });
  }

  /**
   * å¤„ç†è‚¡ç¥¨ç‚¹å‡»
   */
  handleStockClick(stock) {
    if (this.callbacks.onStockClick) {
      this.callbacks.onStockClick(stock);
    } else {
      // é»˜è®¤è¡Œä¸ºï¼šæ‰“å¼€è‚¡ç¥¨è¯¦æƒ…é¡µ
      window.open(`/stock-detail.html?symbol=${stock.symbol}`, '_blank');
    }
  }

  /**
   * å¤„ç†è¡Œä¸šç‚¹å‡»
   */
  handleSectorClick(sector) {
    if (this.callbacks.onSectorClick) {
      this.callbacks.onSectorClick(sector);
    } else {
      // é»˜è®¤è¡Œä¸ºï¼šè·³è½¬åˆ°è¡Œä¸šæ ‡ç­¾é¡µ
      window.location.href = `/tag-detail.html?tagId=sector_${encodeURIComponent(sector)}`;
    }
  }

  /**
   * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
   */
  showLoading() {
    this.container.innerHTML = `
      <div class="heatmap-loading">
        <div class="loading-spinner"></div>
        <p>æ­£åœ¨ç”Ÿæˆçƒ­åŠ›å›¾...</p>
      </div>
    `;
  }

  /**
   * éšè—åŠ è½½çŠ¶æ€
   */
  hideLoading() {
    const loading = this.container.querySelector('.heatmap-loading');
    if (loading) {
      loading.remove();
    }
  }

  /**
   * é”™è¯¯å¤„ç†
   */
  handleError(error) {
    console.error('çƒ­åŠ›å›¾æ¸²æŸ“å¤±è´¥:', error);
    
    this.container.innerHTML = `
      <div class="heatmap-error">
        <div class="error-icon">âš ï¸</div>
        <p>çƒ­åŠ›å›¾æš‚æ—¶æ— æ³•æ˜¾ç¤º</p>
        <button class="retry-btn" onclick="this.parentElement.parentElement.__heatmap.render()">é‡è¯•</button>
      </div>
    `;
    
    // ä¿å­˜å®ä¾‹å¼•ç”¨ä»¥ä¾¿é‡è¯•
    this.container.__heatmap = this;
    
    // è§¦å‘é”™è¯¯å›è°ƒ
    if (this.callbacks.onError) {
      this.callbacks.onError(error);
    }
  }

  /**
   * é”€æ¯ç»„ä»¶
   */
  destroy() {
    if (this.resizeObserver) {
      this.resizeObserver.disconnect();
    }
    
    if (this.renderer) {
      this.renderer.destroy();
    }
    
    this.container.innerHTML = '';
    this.container.classList.remove('stock-heatmap');
    delete this.container.__heatmap;
    
    this.rendered = false;
  }
}

// å¯¼å‡ºåˆ°å…¨å±€
window.StockHeatmap = StockHeatmap;
```

#### 1.2 åˆ›å»º DataProcessor.js

**æ–‡ä»¶è·¯å¾„**: `public/js/heatmap/DataProcessor.js`

```javascript
/**
 * æ•°æ®å¤„ç†å™¨
 * è´Ÿè´£å°†APIæ•°æ®è½¬æ¢ä¸ºçƒ­åŠ›å›¾æ‰€éœ€æ ¼å¼
 */
class DataProcessor {
  /**
   * å¤„ç†è‚¡ç¥¨æ•°æ®
   */
  static processStockData(rawData, groupBy = 'sector') {
    try {
      // æ•°æ®éªŒè¯å’Œæ¸…æ´—
      const cleanData = this.validateAndClean(rawData);
      
      if (cleanData.length === 0) {
        throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„è‚¡ç¥¨æ•°æ®');
      }
      
      // æ„å»ºå±‚æ¬¡ç»“æ„
      const hierarchyData = this.buildHierarchy(cleanData, groupBy);
      
      // è®¡ç®—èšåˆæŒ‡æ ‡
      const enrichedData = this.calculateAggregates(hierarchyData);
      
      return enrichedData;
      
    } catch (error) {
      console.error('æ•°æ®å¤„ç†å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * æ•°æ®éªŒè¯å’Œæ¸…æ´—
   */
  static validateAndClean(data) {
    if (!Array.isArray(data)) {
      console.warn('è¾“å…¥æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œå°è¯•è½¬æ¢');
      data = [data];
    }
    
    return data.filter(stock => {
      // åŸºæœ¬å­—æ®µéªŒè¯
      if (!stock || typeof stock !== 'object') return false;
      if (!stock.symbol || !stock.name) return false;
      
      // æ•°å€¼å­—æ®µéªŒè¯å’Œä¿®æ­£
      stock.market_cap = this.parseNumber(stock.market_cap) || 0;
      stock.change_percent = this.parseNumber(stock.change_percent) || 0;
      stock.price = this.parseNumber(stock.price) || 0;
      
      // è¿‡æ»¤æ‰å¸‚å€¼ä¸º0çš„è‚¡ç¥¨
      return stock.market_cap > 0;
    }).map(stock => {
      // æ ‡å‡†åŒ–å­—æ®µ
      return {
        symbol: stock.symbol.toUpperCase(),
        name: stock.name,
        sector: stock.sector || stock.industry || 'å…¶ä»–',
        market_cap: stock.market_cap,
        change_percent: stock.change_percent,
        price: stock.price,
        volume: stock.volume || 0,
        pe_ratio: stock.pe_ratio || null,
        roe: stock.roe || null
      };
    });
  }

  /**
   * è§£ææ•°å€¼
   */
  static parseNumber(value) {
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
      // ç§»é™¤è´§å¸ç¬¦å·å’Œé€—å·
      const cleaned = value.replace(/[$,]/g, '');
      const parsed = parseFloat(cleaned);
      return isNaN(parsed) ? null : parsed;
    }
    return null;
  }

  /**
   * æ„å»ºå±‚æ¬¡ç»“æ„
   */
  static buildHierarchy(data, groupBy) {
    if (groupBy === 'none') {
      // ä¸åˆ†ç»„ï¼Œç›´æ¥è¿”å›æ‰å¹³ç»“æ„
      return {
        name: 'root',
        children: data.map(stock => ({
          name: stock.symbol,
          value: stock.market_cap,
          change: stock.change_percent,
          data: stock,
          type: 'stock'
        }))
      };
    }

    // æŒ‰æŒ‡å®šå­—æ®µåˆ†ç»„
    const grouped = this.groupBy(data, groupBy);
    
    return {
      name: 'root',
      children: Object.entries(grouped).map(([groupName, stocks]) => ({
        name: groupName,
        type: 'group',
        children: stocks.map(stock => ({
          name: stock.symbol,
          value: stock.market_cap,
          change: stock.change_percent,
          data: stock,
          type: 'stock'
        }))
      }))
    };
  }

  /**
   * æ•°æ®åˆ†ç»„
   */
  static groupBy(data, field) {
    return data.reduce((groups, item) => {
      const key = item[field] || 'å…¶ä»–';
      if (!groups[key]) {
        groups[key] = [];
      }
      groups[key].push(item);
      return groups;
    }, {});
  }

  /**
   * è®¡ç®—èšåˆæŒ‡æ ‡
   */
  static calculateAggregates(hierarchyData) {
    // é€’å½’è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„èšåˆå€¼
    function calculateNode(node) {
      if (node.children) {
        // è®¡ç®—å­èŠ‚ç‚¹
        node.children.forEach(calculateNode);
        
        // èšåˆå­èŠ‚ç‚¹çš„å€¼
        node.value = node.children.reduce((sum, child) => sum + (child.value || 0), 0);
        
        // è®¡ç®—åŠ æƒå¹³å‡å˜åŒ–ç‡
        const totalValue = node.value;
        if (totalValue > 0) {
          node.change = node.children.reduce((sum, child) => {
            const weight = (child.value || 0) / totalValue;
            return sum + (child.change || 0) * weight;
          }, 0);
        } else {
          node.change = 0;
        }
        
        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        node.stats = {
          count: node.children.length,
          avgChange: node.children.reduce((sum, child) => sum + (child.change || 0), 0) / node.children.length,
          maxChange: Math.max(...node.children.map(child => child.change || 0)),
          minChange: Math.min(...node.children.map(child => child.change || 0))
        };
      }
      
      return node;
    }
    
    return calculateNode(hierarchyData);
  }

  /**
   * æ ¼å¼åŒ–æ•°å€¼æ˜¾ç¤º
   */
  static formatValue(value, type = 'currency') {
    if (value === null || value === undefined) return 'N/A';
    
    switch (type) {
      case 'currency':
        return new Intl.NumberFormat('zh-CN', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(value);
        
      case 'percent':
        return new Intl.NumberFormat('zh-CN', {
          style: 'percent',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(value / 100);
        
      case 'number':
        return new Intl.NumberFormat('zh-CN').format(value);
        
      default:
        return value.toString();
    }
  }
}

// å¯¼å‡ºåˆ°å…¨å±€
window.DataProcessor = DataProcessor;
```

### æ­¥éª¤ 2: ä¿®æ”¹æ ‡ç­¾è¯¦æƒ…é¡µ

#### 2.1 ä¿®æ”¹ tag-detail.html

åœ¨ç°æœ‰çš„ `public/tag-detail.html` ä¸­æ·»åŠ çƒ­åŠ›å›¾å®¹å™¨ï¼š

```html
<!-- åœ¨è‚¡ç¥¨åˆ—è¡¨å®¹å™¨ä¹‹å‰æ·»åŠ  -->
<div class="heatmap-section">
  <div class="section-header">
    <h3>ğŸ“Š æ¿å—çƒ­åŠ›å›¾</h3>
    <div class="heatmap-controls">
      <button id="toggle-heatmap" class="btn-secondary">éšè—çƒ­åŠ›å›¾</button>
    </div>
  </div>
  <div id="tag-heatmap" class="heatmap-container"></div>
</div>
```

#### 2.2 ä¿®æ”¹ tag-detail.js

åœ¨ç°æœ‰çš„ `public/scripts/tag-detail.js` ä¸­æ·»åŠ çƒ­åŠ›å›¾é›†æˆï¼š

```javascript
// åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ 
let tagHeatmap = null;

// ä¿®æ”¹ loadStocks å‡½æ•°
async function loadStocks(tagId, page = 1, sortBy = 'market_cap', sortOrder = 'desc') {
  try {
    showLoading();
    
    const response = await fetch(`/api/stocks-by-tag?tag=${tagId}&page=${page}&limit=100&sort=${sortBy}&order=${sortOrder}`);
    const data = await response.json();
    
    if (data.success) {
      // æ¸²æŸ“è‚¡ç¥¨åˆ—è¡¨ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
      renderStocks(data.stocks, page === 1);
      
      // æ–°å¢ï¼šæ¸²æŸ“çƒ­åŠ›å›¾ï¼ˆä»…åœ¨ç¬¬ä¸€é¡µæ—¶ï¼‰
      if (page === 1) {
        renderHeatmap(data.stocks, tagId);
      }
      
      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      updatePagination(data.totalCount, page);
    }
    
  } catch (error) {
    console.error('åŠ è½½è‚¡ç¥¨æ•°æ®å¤±è´¥:', error);
    showError('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  } finally {
    hideLoading();
  }
}

// æ–°å¢ï¼šæ¸²æŸ“çƒ­åŠ›å›¾å‡½æ•°
function renderHeatmap(stocks, tagId) {
  try {
    // é”€æ¯ç°æœ‰çƒ­åŠ›å›¾
    if (tagHeatmap) {
      tagHeatmap.destroy();
    }
    
    // åˆ›å»ºæ–°çš„çƒ­åŠ›å›¾
    tagHeatmap = new StockHeatmap({
      container: '#tag-heatmap',
      data: stocks,
      config: {
        height: 400,
        groupBy: tagId.startsWith('sector_') ? 'none' : 'sector',
        showLabels: true,
        interactive: true
      },
      callbacks: {
        onStockClick: (stock) => {
          window.open(`/stock-detail.html?symbol=${stock.symbol}`, '_blank');
        },
        onSectorClick: (sector) => {
          window.location.href = `/tag-detail.html?tagId=sector_${encodeURIComponent(sector)}`;
        },
        onError: (error) => {
          console.error('çƒ­åŠ›å›¾æ¸²æŸ“å¤±è´¥:', error);
          document.getElementById('tag-heatmap').innerHTML = `
            <div class="heatmap-error">
              <p>çƒ­åŠ›å›¾æš‚æ—¶æ— æ³•æ˜¾ç¤º</p>
            </div>
          `;
        }
      }
    });
    
  } catch (error) {
    console.error('çƒ­åŠ›å›¾åˆå§‹åŒ–å¤±è´¥:', error);
  }
}

// æ–°å¢ï¼šçƒ­åŠ›å›¾æ§åˆ¶åŠŸèƒ½
function setupHeatmapControls() {
  const toggleBtn = document.getElementById('toggle-heatmap');
  const heatmapSection = document.querySelector('.heatmap-section');
  
  if (toggleBtn && heatmapSection) {
    toggleBtn.addEventListener('click', () => {
      const isHidden = heatmapSection.style.display === 'none';
      heatmapSection.style.display = isHidden ? 'block' : 'none';
      toggleBtn.textContent = isHidden ? 'éšè—çƒ­åŠ›å›¾' : 'æ˜¾ç¤ºçƒ­åŠ›å›¾';
    });
  }
}

// åœ¨é¡µé¢åˆå§‹åŒ–æ—¶è°ƒç”¨
document.addEventListener('DOMContentLoaded', () => {
  // åŸæœ‰åˆå§‹åŒ–é€»è¾‘...
  
  // æ–°å¢ï¼šè®¾ç½®çƒ­åŠ›å›¾æ§åˆ¶
  setupHeatmapControls();
});
```

#### 2.3 æ·»åŠ æ ·å¼æ–‡ä»¶

åˆ›å»º `public/styles/heatmap-core.css`ï¼š

```css
/* çƒ­åŠ›å›¾æ ¸å¿ƒæ ·å¼ */
.stock-heatmap {
  position: relative;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  overflow: hidden;
}

.heatmap-section {
  margin: 20px 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  overflow: hidden;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.section-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.heatmap-controls {
  display: flex;
  gap: 8px;
}

.btn-secondary {
  padding: 6px 12px;
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 6px;
  color: white;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-secondary:hover {
  background: rgba(255,255,255,0.3);
}

.heatmap-container {
  padding: 20px;
  min-height: 400px;
}

/* åŠ è½½çŠ¶æ€ */
.heatmap-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 300px;
  color: #6c757d;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* é”™è¯¯çŠ¶æ€ */
.heatmap-error {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: #dc3545;
  text-align: center;
}

.error-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.retry-btn {
  margin-top: 12px;
  padding: 8px 16px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}

.retry-btn:hover {
  background: #0056b3;
}

/* çƒ­åŠ›å›¾å…ƒç´ æ ·å¼ */
.heatmap-rect {
  stroke: #fff;
  stroke-width: 1;
  cursor: pointer;
  transition: all 0.2s;
}

.heatmap-rect:hover,
.heatmap-hover {
  stroke: #333;
  stroke-width: 2;
  filter: brightness(1.1);
}

.heatmap-label {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 12px;
  font-weight: 500;
  fill: #333;
  pointer-events: none;
  text-anchor: middle;
  dominant-baseline: central;
}

.heatmap-group-label {
  font-size: 14px;
  font-weight: 600;
  fill: #000;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .heatmap-container {
    padding: 12px;
  }
  
  .section-header {
    padding: 12px 16px;
  }
  
  .section-header h3 {
    font-size: 16px;
  }
  
  .heatmap-label {
    font-size: 10px;
  }
}
```

---

## 3. å•å…ƒæµ‹è¯•æŒ‡å—

### 3.1 æµ‹è¯•ç¯å¢ƒè®¾ç½®

åˆ›å»º `tests/heatmap.test.js`ï¼š

```javascript
// æ¨¡æ‹Ÿæµ‹è¯•æ•°æ®
const mockStockData = [
  {
    symbol: 'AAPL',
    name: 'Apple Inc.',
    sector: 'ä¿¡æ¯æŠ€æœ¯',
    market_cap: 3000000000000,
    change_percent: 2.5,
    price: 150.25
  },
  {
    symbol: 'MSFT',
    name: 'Microsoft Corporation',
    sector: 'ä¿¡æ¯æŠ€æœ¯',
    market_cap: 2800000000000,
    change_percent: 1.8,
    price: 380.50
  },
  {
    symbol: 'GOOGL',
    name: 'Alphabet Inc.',
    sector: 'ä¿¡æ¯æŠ€æœ¯',
    market_cap: 1800000000000,
    change_percent: -0.5,
    price: 2750.00
  }
];

// æµ‹è¯•æ•°æ®å¤„ç†å™¨
describe('DataProcessor', () => {
  test('should process stock data correctly', () => {
    const processed = DataProcessor.processStockData(mockStockData, 'sector');
    
    expect(processed).toHaveProperty('name', 'root');
    expect(processed.children).toHaveLength(1); // åªæœ‰ä¸€ä¸ªè¡Œä¸š
    expect(processed.children[0].name).toBe('ä¿¡æ¯æŠ€æœ¯');
    expect(processed.children[0].children).toHaveLength(3); // ä¸‰åªè‚¡ç¥¨
  });
  
  test('should handle empty data', () => {
    expect(() => {
      DataProcessor.processStockData([]);
    }).toThrow('æ²¡æœ‰æœ‰æ•ˆçš„è‚¡ç¥¨æ•°æ®');
  });
  
  test('should clean invalid data', () => {
    const invalidData = [
      { symbol: 'AAPL', name: 'Apple', market_cap: 'invalid' },
      { symbol: 'MSFT', name: 'Microsoft', market_cap: 1000000 },
      null,
      undefined
    ];
    
    const processed = DataProcessor.processStockData(invalidData, 'none');
    expect(processed.children).toHaveLength(1); // åªæœ‰ä¸€ä¸ªæœ‰æ•ˆæ•°æ®
  });
});

// æµ‹è¯•çƒ­åŠ›å›¾ç»„ä»¶
describe('StockHeatmap', () => {
  let container;
  
  beforeEach(() => {
    container = document.createElement('div');
    container.id = 'test-heatmap';
    document.body.appendChild(container);
  });
  
  afterEach(() => {
    document.body.removeChild(container);
  });
  
  test('should create instance without errors', () => {
    expect(() => {
      new StockHeatmap({
        container: '#test-heatmap',
        data: mockStockData
      });
    }).not.toThrow();
  });
  
  test('should throw error for missing container', () => {
    expect(() => {
      new StockHeatmap({ data: mockStockData });
    }).toThrow('å®¹å™¨é€‰æ‹©å™¨æ˜¯å¿…éœ€çš„');
  });
  
  test('should render without errors', async () => {
    const heatmap = new StockHeatmap({
      container: '#test-heatmap',
      data: mockStockData
    });
    
    await expect(heatmap.render()).resolves.not.toThrow();
  });
});
```

### 3.2 é›†æˆæµ‹è¯•

åˆ›å»º `tests/integration.test.js`ï¼š

```javascript
// æµ‹è¯•é¡µé¢é›†æˆ
describe('Tag Detail Page Integration', () => {
  beforeEach(() => {
    // è®¾ç½®DOMç¯å¢ƒ
    document.body.innerHTML = `
      <div id="tag-heatmap"></div>
      <div id="stocks-container"></div>
    `;
    
    // æ¨¡æ‹Ÿfetch
    global.fetch = jest.fn();
  });
  
  test('should load heatmap when stocks data is available', async () => {
    // æ¨¡æ‹ŸAPIå“åº”
    fetch.mockResolvedValueOnce({
      ok: true,
      json: async () => ({
        success: true,
        stocks: mockStockData,
        totalCount: 3
      })
    });
    
    // æ¨¡æ‹Ÿé¡µé¢åŠ è½½
    await loadStocks('test-tag');
    
    // éªŒè¯çƒ­åŠ›å›¾å®¹å™¨æ˜¯å¦æœ‰å†…å®¹
    const heatmapContainer = document.getElementById('tag-heatmap');
    expect(heatmapContainer.children.length).toBeGreaterThan(0);
  });
});
```

---

## 4. éƒ¨ç½²æ£€æŸ¥æ¸…å•

### 4.1 ä»£ç æ£€æŸ¥
- [ ] æ‰€æœ‰æ–°æ–‡ä»¶å·²æ·»åŠ åˆ°ç‰ˆæœ¬æ§åˆ¶
- [ ] ä»£ç é€šè¿‡ESLintæ£€æŸ¥
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•å®Œæˆ

### 4.2 åŠŸèƒ½æ£€æŸ¥
- [ ] æ ‡ç­¾è¯¦æƒ…é¡µçƒ­åŠ›å›¾æ­£å¸¸æ˜¾ç¤º
- [ ] è¶‹åŠ¿æ¦œå•é¡µè¿·ä½ çƒ­åŠ›å›¾æ­£å¸¸æ˜¾ç¤º
- [ ] çƒ­åŠ›å›¾äº¤äº’åŠŸèƒ½æ­£å¸¸
- [ ] å“åº”å¼å¸ƒå±€æ­£å¸¸
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸

### 4.3 æ€§èƒ½æ£€æŸ¥
- [ ] é¡µé¢åŠ è½½æ—¶é—´åœ¨å¯æ¥å—èŒƒå›´å†…
- [ ] çƒ­åŠ›å›¾æ¸²æŸ“æ—¶é—´ < 500ms
- [ ] å†…å­˜ä½¿ç”¨æ­£å¸¸ï¼Œæ— å†…å­˜æ³„æ¼
- [ ] å¤šä¸ªçƒ­åŠ›å›¾åŒæ—¶æ¸²æŸ“æ€§èƒ½æ­£å¸¸

### 4.4 ç”¨æˆ·ä½“éªŒæ£€æŸ¥
- [ ] åŠ è½½çŠ¶æ€æ˜¾ç¤ºæ­£å¸¸
- [ ] é”™è¯¯çŠ¶æ€æ˜¾ç¤ºå‹å¥½
- [ ] äº¤äº’åé¦ˆåŠæ—¶
- [ ] ç§»åŠ¨ç«¯ä½“éªŒè‰¯å¥½

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¸‹ä¸€æ­¥**: å¼€å§‹å®é™…å¼€å‘å®æ–½