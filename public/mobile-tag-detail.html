<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ‡ç­¾è¯¦æƒ… - Stock Tag Explorer</title>
    <link rel="stylesheet" href="./styles/mobile-tag-detail.css">
</head>
<body>
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-left">
            <span class="time">9:41</span>
        </div>
        <div class="status-right">
            <span class="battery">100%</span>
            <span class="signal">ğŸ“¶</span>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-container">
        <!-- å›ºå®šé¡µé¦–å¯¼èˆªæ¡ -->
        <div class="fixed-top-nav">
            <!-- é¡µé¢å¤´éƒ¨å¡ç‰‡ -->
            <div class="page-header-card">
                <div class="header-accent-line"></div>
                <button class="back-btn" onclick="history.back()">
                    <span class="back-icon">â†</span>
                    <span>è¿”å›</span>
                </button>
                <div class="header-content">
                    <div class="breadcrumb">
                        <span class="breadcrumb-item">æ ‡ç­¾å¹¿åœº</span>
                        <span class="breadcrumb-separator">></span>
                        <span id="tag-name" class="breadcrumb-current">åŠ è½½ä¸­...</span>
                    </div>
                    <h1 id="page-title" class="page-title">æ ‡ç­¾è¯¦æƒ…</h1>
                    <p id="tag-description" class="tag-description">æŸ¥çœ‹è¯¥æ ‡ç­¾ä¸‹çš„æ‰€æœ‰è‚¡ç¥¨</p>
                </div>
            </div>

            <!-- æ ‡ç­¾ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-card">
                <div class="stats-accent-line"></div>
                <div class="stats-header">
                    <h4>ğŸ“Š æ ‡ç­¾ç»Ÿè®¡</h4>
                </div>
                <div class="stats-grid">
                    <div class="stats-item">
                        <span class="stats-number" id="total-stocks">-</span>
                        <span class="stats-label">æ€»è‚¡ç¥¨æ•°</span>
                    </div>
                    <div class="stats-item stats-up">
                        <span class="stats-number" id="rising-stocks">-</span>
                        <span class="stats-label">ä¸Šæ¶¨</span>
                    </div>
                    <div class="stats-item stats-down">
                        <span class="stats-number" id="falling-stocks">-</span>
                        <span class="stats-label">ä¸‹è·Œ</span>
                    </div>
                    <div class="stats-item stats-flat">
                        <span class="stats-number" id="flat-stocks">-</span>
                        <span class="stats-label">å¹³ç›˜</span>
                    </div>
                </div>
            </div>

            <!-- æ’åºå’Œç­›é€‰å¡ç‰‡ -->
            <div class="filter-card">
                <div class="filter-accent-line"></div>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="sort-select">æ’åº</label>
                        <select id="sort-select" class="sort-select">
                            <option value="change-desc">æ¶¨è·Œå¹… â†“</option>
                            <option value="change-asc">æ¶¨è·Œå¹… â†‘</option>
                            <option value="volume-desc">æˆäº¤é‡ â†“</option>
                            <option value="volume-asc">æˆäº¤é‡ â†‘</option>
                            <option value="marketcap-desc">å¸‚å€¼ â†“</option>
                            <option value="marketcap-asc">å¸‚å€¼ â†‘</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="change-filter">ç­›é€‰</label>
                        <select id="change-filter" class="change-filter">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="up">ä¸Šæ¶¨</option>
                            <option value="down">ä¸‹è·Œ</option>
                            <option value="flat">å¹³ç›˜</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‚¡ç¥¨åˆ—è¡¨å¡ç‰‡ -->
        <div class="stock-list-card">
            <div class="stock-list-accent-line"></div>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading-state" class="loading-state">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åŠ è½½è‚¡ç¥¨æ•°æ®...</p>
            </div>

            <!-- é”™è¯¯çŠ¶æ€ -->
            <div id="error-state" class="error-state" style="display: none;">
                <div class="error-icon">âš ï¸</div>
                <p class="error-message">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>
                <button class="retry-btn" onclick="loadTagDetail()">é‡æ–°åŠ è½½</button>
            </div>

            <!-- è‚¡ç¥¨åˆ—è¡¨ -->
            <div id="stock-list" class="stock-list" style="display: none;">
                <!-- è‚¡ç¥¨é¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">ğŸ“Š</div>
                <p class="empty-message">è¯¥æ ‡ç­¾ä¸‹æš‚æ— è‚¡ç¥¨æ•°æ®</p>
            </div>
        </div>

        <!-- ç›¸å…³æ ‡ç­¾å¡ç‰‡ -->
        <div class="related-tags-card">
            <div class="related-tags-accent-line"></div>
            <div class="related-tags-header">
                <h4>ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
            </div>
            <div id="related-tags" class="related-tags-list">
                <!-- ç›¸å…³æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
     </div>

     <!-- Toast é€šçŸ¥ -->
     <div id="toast" class="toast"></div>

     <script>
         // è·å–URLå‚æ•°
         function getUrlParameter(name) {
             name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
             const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
             const results = regex.exec(location.search);
             return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
         }

         // æ˜¾ç¤ºToastæ¶ˆæ¯
         function showToast(message, type = 'info') {
             const toast = document.getElementById('toast');
             toast.textContent = message;
             toast.className = `toast show ${type}`;
             setTimeout(() => {
                 toast.className = 'toast';
             }, 3000);
         }

         // æ ¼å¼åŒ–æ•°å­—
         function formatNumber(num) {
             if (num >= 1e12) return (num / 1e12).toFixed(1) + 'T';
             if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
             if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
             if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
             return num.toString();
         }

         // æ ¼å¼åŒ–ç™¾åˆ†æ¯”
         function formatPercentage(num) {
             return (num >= 0 ? '+' : '') + num.toFixed(2) + '%';
         }

         // åˆ›å»ºè‚¡ç¥¨é¡¹ç›®HTML
         function createStockItem(stock) {
             const changeClass = stock.changePercent > 0 ? 'positive' : stock.changePercent < 0 ? 'negative' : 'neutral';
             return `
                 <div class="stock-item" onclick="viewStockDetail('${stock.code}')">
                     <div class="stock-info">
                         <div class="stock-symbol">${stock.code}</div>
                         <div class="stock-name">${stock.name}</div>
                         <div class="stock-meta">
                             <span class="market-cap">å¸‚å€¼: ${formatNumber(stock.marketCap)}</span>
                             <span class="volume">æˆäº¤é‡: ${formatNumber(stock.volume)}</span>
                         </div>
                     </div>
                     <div class="stock-price">
                         <div class="price">Â¥${stock.price.toFixed(2)}</div>
                         <div class="change ${changeClass}">${formatPercentage(stock.changePercent)}</div>
                     </div>
                 </div>
             `;
         }

         // åˆ›å»ºç›¸å…³æ ‡ç­¾HTML
         function createRelatedTag(tag) {
             return `
                 <div class="related-tag" onclick="navigateToTag('${tag.id}')">
                     <span class="tag-name">${tag.name}</span>
                     <span class="tag-count">${tag.stockCount || tag.count || 0}</span>
                 </div>
             `;
         }

         // åŠ è½½æ ‡ç­¾è¯¦æƒ…
         async function loadTagDetail() {
             const tagId = getUrlParameter('tagId');
             if (!tagId) {
                 showToast('ç¼ºå°‘æ ‡ç­¾IDå‚æ•°', 'error');
                 return;
             }

             try {
                 // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                 document.getElementById('loading-state').style.display = 'block';
                 document.getElementById('error-state').style.display = 'none';
                 document.getElementById('stock-list').style.display = 'none';
                 document.getElementById('empty-state').style.display = 'none';

                 // è·å–æ ‡ç­¾ä¿¡æ¯
                 const tagsResponse = await fetch('/api/tags');
                 const tagsResult = await tagsResponse.json();
                 
                 // ä»åˆ†ç»„æ•°æ®ä¸­æŸ¥æ‰¾å½“å‰æ ‡ç­¾
                 let currentTag = null;
                 if (tagsResult.success && tagsResult.data) {
                     // éå†æ‰€æœ‰åˆ†ç±»æŸ¥æ‰¾æ ‡ç­¾
                     for (const category in tagsResult.data) {
                         const tags = tagsResult.data[category];
                         if (Array.isArray(tags)) {
                             currentTag = tags.find(tag => tag.id === tagId);
                             if (currentTag) break;
                         }
                     }
                 }
                 
                 if (!currentTag) {
                     throw new Error('æ ‡ç­¾ä¸å­˜åœ¨');
                 }

                 // è·å–æ ‡ç­¾ä¸‹çš„è‚¡ç¥¨æ•°æ®ï¼ˆåŒ…å«ç›¸å…³æ ‡ç­¾ï¼‰
                 const stocksResponse = await fetch(`/api/tag-stocks?tag=${encodeURIComponent(currentTag.name)}`);
                 const stocksData = await stocksResponse.json();

                 const tagData = {
                     id: currentTag.id,
                     name: currentTag.name,
                     description: currentTag.description,
                     stocks: stocksData.data?.stocks || [],
                     relatedTags: stocksData.data?.relatedTags || []
                 };

                 // æ›´æ–°é¡µé¢å†…å®¹
                 document.getElementById('tag-name').textContent = tagData.name;
                 document.getElementById('page-title').textContent = tagData.name;
                 document.getElementById('tag-description').textContent = tagData.description;

                 // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                 const totalStocks = tagData.stocks.length;
                 const risingStocks = tagData.stocks.filter(s => s.changePercent > 0).length;
                 const fallingStocks = tagData.stocks.filter(s => s.changePercent < 0).length;
                 const flatStocks = tagData.stocks.filter(s => s.changePercent === 0).length;

                 document.getElementById('total-stocks').textContent = totalStocks;
                 document.getElementById('rising-stocks').textContent = risingStocks;
                 document.getElementById('falling-stocks').textContent = fallingStocks;
                 document.getElementById('flat-stocks').textContent = flatStocks;

                 // æ¸²æŸ“è‚¡ç¥¨åˆ—è¡¨
                 const stockList = document.getElementById('stock-list');
                 if (tagData.stocks.length > 0) {
                     stockList.innerHTML = tagData.stocks.map(createStockItem).join('');
                     stockList.style.display = 'block';
                 } else {
                     document.getElementById('empty-state').style.display = 'block';
                 }

                 // æ¸²æŸ“ç›¸å…³æ ‡ç­¾
                 const relatedTags = document.getElementById('related-tags');
                 relatedTags.innerHTML = tagData.relatedTags.map(createRelatedTag).join('');

                 // éšè—åŠ è½½çŠ¶æ€
                 document.getElementById('loading-state').style.display = 'none';

             } catch (error) {
                 console.error('åŠ è½½æ ‡ç­¾è¯¦æƒ…å¤±è´¥:', error);
                 document.getElementById('loading-state').style.display = 'none';
                 document.getElementById('error-state').style.display = 'block';
                 showToast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
             }
         }

         // æŸ¥çœ‹è‚¡ç¥¨è¯¦æƒ…
         function viewStockDetail(code) {
             showToast(`æŸ¥çœ‹ ${code} è¯¦æƒ…`, 'info');
             // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°è‚¡ç¥¨è¯¦æƒ…é¡µé¢
         }

         // å¯¼èˆªåˆ°æ ‡ç­¾
         function navigateToTag(tagId) {
             window.location.href = `mobile-tag-detail.html?tagId=${tagId}`;
         }

         // æ’åºå’Œç­›é€‰åŠŸèƒ½
         document.getElementById('sort-select').addEventListener('change', function() {
             showToast('æ’åºåŠŸèƒ½å¼€å‘ä¸­', 'info');
         });

         document.getElementById('change-filter').addEventListener('change', function() {
             showToast('ç­›é€‰åŠŸèƒ½å¼€å‘ä¸­', 'info');
         });

         // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
         document.addEventListener('DOMContentLoaded', function() {
             loadTagDetail();
         });
     </script>
</body>
</html>