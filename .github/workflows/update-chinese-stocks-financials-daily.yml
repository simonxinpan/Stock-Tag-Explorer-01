name: Chinese Stocks ETL Daily Starter (Reset Task Queue)

on:
  schedule:
    # ‰∏≠Ê¶ÇËÇ°‰∫§ÊòìÊó∂Èó¥ÔºöÁæé‰∏úÊó∂Èó¥Âë®‰∏ÄÂà∞Âë®‰∫îÊó©‰∏ä9:25 AM (ÂºÄÁõòÂâç5ÂàÜÈíü) - ÂêØÂä®ETL
    # ‰ΩøÁî®UTC 13:25 (Â§ßÈÉ®ÂàÜÊó∂Èó¥ÈÄÇÁî®ÔºåÂåÖÊã¨Â§è‰ª§Êó∂)
    - cron: '27 13 * * 1-5'  # ÂêØÂä®ETL‰ªªÂä°ÈòüÂàóÔºàÊØîÊ†áÊôÆ500Êôö2ÂàÜÈíüÔºâ
    # Áæé‰∏úÊó∂Èó¥Âë®‰∏ÄÂà∞Âë®‰∫î‰∏ãÂçà4:05 PM (Êî∂ÁõòÂêé5ÂàÜÈíü) - ÂÅúÊ≠¢ETL  
    # ‰ΩøÁî®UTC 20:05 (Â§ßÈÉ®ÂàÜÊó∂Èó¥ÈÄÇÁî®ÔºåÂåÖÊã¨Â§è‰ª§Êó∂)
    - cron: '7 20 * * 1-5'   # ÂÅúÊ≠¢ETL‰ªªÂä°ÈòüÂàóÔºàÊØîÊ†áÊôÆ500Êôö2ÂàÜÈíüÔºâ
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
    inputs:
      action:
        description: 'ETL Action'
        required: true
        default: 'start'
        type: choice
        options:
          - 'start'
          - 'stop'

jobs:
  manage-chinese-stocks-daily-etl:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # 5ÂàÜÈíüË∂ÖÊó∂
    
    steps:
      - name: Determine ETL Action
        id: determine-action
        run: |
          # Á°ÆÂÆöÊâßË°åÁöÑÊìç‰ΩúÔºàÂêØÂä®ÊàñÂÅúÊ≠¢Ôºâ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            action="${{ github.event.inputs.action }}"
          else
            # Ê†πÊçÆcronÊó∂Èó¥Âà§Êñ≠Êìç‰Ωú
            current_hour=$(date -u +%H)
            current_minute=$(date -u +%M)
            
            # ÂêØÂä®Êó∂Èó¥: 13:27 (Áæé‰∏úÊó∂Èó¥9:27 AM)
            if [ "$current_hour" = "13" ] && [ "$current_minute" = "27" ]; then
              action="start"
            # ÂÅúÊ≠¢Êó∂Èó¥: 20:07 (Áæé‰∏úÊó∂Èó¥4:07 PM)
            elif [ "$current_hour" = "20" ] && [ "$current_minute" = "07" ]; then
              action="stop"
            else
              # Â¶ÇÊûú‰∏çÂú®È¢ÑÂÆöÊó∂Èó¥ÔºåÊ†πÊçÆÂΩìÂâçÊó∂Èó¥Âà§Êñ≠Â∫îËØ•ÂêØÂä®ËøòÊòØÂÅúÊ≠¢
              # 13:27-20:07‰πãÈó¥Â∫îËØ•ÊòØËøêË°åÁä∂ÊÄÅÔºåÂÖ∂‰ªñÊó∂Èó¥Â∫îËØ•ÂÅúÊ≠¢
              if [ "$current_hour" -gt 13 ] || ([ "$current_hour" -eq 13 ] && [ "$current_minute" -ge 27 ]); then
                if [ "$current_hour" -lt 20 ] || ([ "$current_hour" -eq 20 ] && [ "$current_minute" -lt 7 ]); then
                  action="start"  # ‰∫§ÊòìÊó∂Èó¥ÂÜÖ
                else
                  action="stop"   # ‰∫§ÊòìÊó∂Èó¥Â§ñ
                fi
              else
                action="stop"     # ‰∫§ÊòìÊó∂Èó¥Â§ñ
              fi
            fi
          fi
          
          echo "action=$action" >> $GITHUB_OUTPUT
          echo "üéØ ETL Action determined: $action"
          
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Start Chinese Stocks ETL Task Queue
        if: steps.determine-action.outputs.action == 'start'
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          MARKET_TYPE: 'chinese_stocks'
        run: |
          echo "üöÄ Starting Chinese Stocks ETL Task Queue..."
          echo "üìä Market: Chinese Stocks"
          echo "‚è∞ Trading hours: 9:30 AM - 4:00 PM ET"
          node _scripts/etl-smart-batch-processor.mjs start
          
      - name: Stop Chinese Stocks ETL Task Queue
        if: steps.determine-action.outputs.action == 'stop'
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          MARKET_TYPE: 'chinese_stocks'
        run: |
          echo "üõë Stopping Chinese Stocks ETL Task Queue..."
          echo "üìä Market: Chinese Stocks"
          echo "‚è∞ After trading hours"
          node _scripts/etl-smart-batch-processor.mjs stop
          
      - name: Verify ETL Status
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          MARKET_TYPE: chinese_stocks
        run: |
          echo "üîç Verifying Chinese Stocks ETL status..."
          node _scripts/etl-smart-batch-processor.mjs status
          
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: chinese-stocks-etl-logs
          path: |
            /home/runner/work/Stock-Tag-Explorer-01/Stock-Tag-Explorer-01/*.log
          retention-days: 7