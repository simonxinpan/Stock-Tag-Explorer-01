# æ–‡ä»¶: .github/workflows/update-sp500-unified.yml
# ç‰ˆæœ¬: Unified S&P 500 Data Update Workflow
# åŠŸèƒ½: ç»Ÿä¸€çš„S&P 500æ•°æ®æ›´æ–°ï¼Œæ”¯æŒå®Œæ•´Neonæ•°æ®åº“å­—æ®µåŒ¹é…å’Œæ™ºèƒ½æ‰¹æ¬¡å¤„ç†

name: S&P 500 Unified Data Update

on:
  # äº¤æ˜“æ—¶æ®µé«˜é¢‘æ›´æ–° (UTC 13:30-20:00, å‘¨ä¸€è‡³å‘¨äº”)
  schedule:
    # æ¯10åˆ†é’Ÿè§¦å‘ä¸€æ¬¡æ‰¹æ¬¡å¤„ç†
    - cron: '*/10 13-20 * * 1-5'
    # é—­å¸‚åå®Œæ•´æ›´æ–°
    - cron: '5 21 * * 1-5'
    # å¼€ç›˜å‰é¢„çƒ­æ›´æ–°
    - cron: '25 13 * * 1-5'
  
  # æ‰‹åŠ¨è§¦å‘æ”¯æŒ
  workflow_dispatch:
    inputs:
      batch_mode:
        description: 'æ‰¹æ¬¡å¤„ç†æ¨¡å¼'
        required: true
        default: 'auto'
        type: choice
        options:
          - 'auto'      # è‡ªåŠ¨æ‰¹æ¬¡å¤„ç†
          - 'single'    # å•æ‰¹æ¬¡å¤„ç†
          - 'full'      # å®Œæ•´æ›´æ–°
      batch_number:
        description: 'æŒ‡å®šæ‰¹æ¬¡å· (1-11, ä»…singleæ¨¡å¼)'
        required: false
        default: '1'
      debug_mode:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å­—æ®µ'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# é˜²æ­¢å¹¶å‘æ‰§è¡Œï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
concurrency:
  group: sp500-unified-update
  cancel-in-progress: false

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
  POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
  DEBUG: ${{ github.event.inputs.debug_mode || 'false' }}
  BATCH_MODE: ${{ github.event.inputs.batch_mode || 'auto' }}
  FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}

jobs:
  # é¢„æ£€æŸ¥ä½œä¸š
  pre_check:
    name: "ğŸ” Pre-flight Checks"
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      api_status: ${{ steps.api_check.outputs.status }}
      batch_strategy: ${{ steps.batch_plan.outputs.strategy }}
      total_batches: ${{ steps.batch_plan.outputs.total_batches }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: API Connectivity Check
        id: api_check
        run: |
          echo "ğŸ” æ£€æŸ¥ Finnhub API è¿é€šæ€§..."
          if curl -f "https://finnhub.io/api/v1/quote?symbol=AAPL&token=$FINNHUB_API_KEY" > /dev/null 2>&1; then
            echo "âœ… Finnhub API å¯è®¿é—®"
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "âŒ Finnhub API ä¸å¯è®¿é—®"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ -n "$POLYGON_API_KEY" ]; then
            echo "ğŸ” æ£€æŸ¥ Polygon API è¿é€šæ€§..."
            if curl -f "https://api.polygon.io/v2/aggs/ticker/AAPL/prev?apikey=$POLYGON_API_KEY" > /dev/null 2>&1; then
              echo "âœ… Polygon API å¯è®¿é—®"
            else
              echo "âš ï¸ Polygon API ä¸å¯è®¿é—®ï¼Œå°†ä»…ä½¿ç”¨ Finnhub"
            fi
          fi
          
      - name: Batch Strategy Planning
        id: batch_plan
        run: |
          if [ "$BATCH_MODE" = "auto" ]; then
            echo "ğŸ“‹ è‡ªåŠ¨æ‰¹æ¬¡æ¨¡å¼ï¼šå°†å¤„ç†æ‰€æœ‰11ä¸ªæ‰¹æ¬¡"
            echo "strategy=auto" >> $GITHUB_OUTPUT
            echo "total_batches=11" >> $GITHUB_OUTPUT
          elif [ "$BATCH_MODE" = "single" ]; then
            echo "ğŸ¯ å•æ‰¹æ¬¡æ¨¡å¼ï¼šå¤„ç†æ‰¹æ¬¡ ${{ github.event.inputs.batch_number }}"
            echo "strategy=single" >> $GITHUB_OUTPUT
            echo "total_batches=1" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ å®Œæ•´æ›´æ–°æ¨¡å¼ï¼šä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰è‚¡ç¥¨"
            echo "strategy=full" >> $GITHUB_OUTPUT
            echo "total_batches=1" >> $GITHUB_OUTPUT
          fi

  # æ‰¹æ¬¡å¤„ç†ä½œä¸š
  batch_update:
    name: "ğŸ“Š Batch ${{ matrix.batch }} Update"
    runs-on: ubuntu-latest
    needs: pre_check
    if: needs.pre_check.outputs.api_status == 'ok'
    timeout-minutes: 12
    
    strategy:
      matrix:
        batch: ${{ 
          needs.pre_check.outputs.batch_strategy == 'auto' && fromJson('[1,2,3,4,5,6,7,8,9,10,11]') ||
          needs.pre_check.outputs.batch_strategy == 'single' && fromJson(format('[{0}]', github.event.inputs.batch_number)) ||
          fromJson('[0]')
        }}
      max-parallel: 1  # ç¡®ä¿æ‰¹æ¬¡é¡ºåºæ‰§è¡Œ
      fail-fast: false
    
    env:
      CURRENT_BATCH: ${{ matrix.batch }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Calculate Batch Range
        id: batch_range
        run: |
          if [ "$BATCH_MODE" = "full" ]; then
            echo "BATCH_START=1" >> $GITHUB_ENV
            echo "BATCH_END=550" >> $GITHUB_ENV
            echo "ğŸ“Š å®Œæ•´æ›´æ–°æ¨¡å¼ï¼šå¤„ç†æ‰€æœ‰550åªè‚¡ç¥¨"
          else
            BATCH_START=$(( ($CURRENT_BATCH - 1) * 50 + 1 ))
            BATCH_END=$(( $CURRENT_BATCH * 50 ))
            echo "BATCH_START=$BATCH_START" >> $GITHUB_ENV
            echo "BATCH_END=$BATCH_END" >> $GITHUB_ENV
            echo "ğŸ“Š æ‰¹æ¬¡ $CURRENT_BATCHï¼šå¤„ç†è‚¡ç¥¨ $BATCH_START-$BATCH_END"
          fi
          
      - name: Wait for Batch Interval
        if: matrix.batch > 1 && needs.pre_check.outputs.batch_strategy == 'auto'
        run: |
          WAIT_TIME=$(( ($CURRENT_BATCH - 1) * 600 ))  # æ¯æ‰¹æ¬¡é—´éš”10åˆ†é’Ÿ
          echo "â±ï¸ ç­‰å¾… $WAIT_TIME ç§’ä»¥ç»´æŒæ‰¹æ¬¡é—´éš”..."
          sleep $WAIT_TIME
          
      - name: Execute S&P 500 Data Update
        run: |
          echo "ğŸš€ å¼€å§‹ S&P 500 æ•°æ®æ›´æ–° - æ‰¹æ¬¡ $CURRENT_BATCH"
          echo "ğŸ“ˆ è‚¡ç¥¨èŒƒå›´: $BATCH_START-$BATCH_END"
          echo "ğŸ”„ é¢„è®¡è¿è¡Œæ—¶é—´: 3-4åˆ†é’Ÿ"
          
          # ä½¿ç”¨å¢å¼ºçš„æ•°æ®æ›´æ–°è„šæœ¬
          node _scripts/update-sp500-enhanced.mjs
          
      - name: Batch Completion Report
        run: |
          echo "âœ… æ‰¹æ¬¡ $CURRENT_BATCH æ›´æ–°å®Œæˆ"
          if [ "$BATCH_MODE" = "auto" ] && [ "$CURRENT_BATCH" -lt "11" ]; then
            NEXT_BATCH=$(( $CURRENT_BATCH + 1 ))
            echo "â­ï¸ ä¸‹ä¸€æ‰¹æ¬¡ $NEXT_BATCH å°†åœ¨10åˆ†é’Ÿåå¼€å§‹"
          fi

  # å®ŒæˆåéªŒè¯ä½œä¸š
  post_update_verification:
    name: "âœ… Post-Update Verification"
    runs-on: ubuntu-latest
    needs: [pre_check, batch_update]
    if: always() && needs.pre_check.outputs.api_status == 'ok'
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Verify Database Updates
        run: |
          echo "ğŸ” éªŒè¯æ•°æ®åº“æ›´æ–°çŠ¶æ€..."
          node _scripts/verify-sp500-updates.mjs
          
      - name: Generate Update Report
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ›´æ–°æŠ¥å‘Š..."
          echo "ğŸ¯ æ‰¹æ¬¡æ¨¡å¼: $BATCH_MODE"
          echo "ğŸ“ˆ å¤„ç†æ‰¹æ¬¡æ•°: ${{ needs.pre_check.outputs.total_batches }}"
          echo "â° æ›´æ–°æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "âœ… S&P 500 ç»Ÿä¸€æ•°æ®æ›´æ–°æµç¨‹å®Œæˆ"