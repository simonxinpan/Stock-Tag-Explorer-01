name: ETL Daily Starter (Reset Task Queue)

on:
  schedule:
    - cron: '0 23 * * *'  # æ¯å¤© UTC 23:00 è¿è¡Œï¼ˆç¾è‚¡æ”¶ç›˜åï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  start-daily-etl:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # 5åˆ†é’Ÿè¶…æ—¶ï¼Œåªæ˜¯é‡ç½®ä»»åŠ¡é˜Ÿåˆ—
    
    steps:
      - name: Reset ETL Task Queue
        run: |
          echo "ğŸ”„ Starting daily ETL process at $(date)"
          echo "ğŸ“‹ Resetting task queue for all stocks..."
          
          # è°ƒç”¨ETLå¯åŠ¨APIé‡ç½®ä»»åŠ¡é˜Ÿåˆ—
           response=$(curl -s -w "\n%{http_code}" -X POST \
             -H "Content-Type: application/json" \
             -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
             "https://${{ secrets.VERCEL_DOMAIN }}/api/etl/start")
          
          # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | head -n -1)
          
          echo "ğŸ“Š API Response (HTTP $http_code):"
          echo "$response_body" | jq '.' 2>/dev/null || echo "$response_body"
          
          # æ£€æŸ¥HTTPçŠ¶æ€ç 
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… ETL task queue reset successfully"
            
            # è§£æå“åº”è·å–é‡ç½®ç»Ÿè®¡
            reset_count=$(echo "$response_body" | jq -r '.resetCount // "N/A"')
            estimated_hours=$(echo "$response_body" | jq -r '.estimatedCompletionHours // "N/A"')
            
            echo "ğŸ“ˆ Reset Stats:"
            echo "  - Stocks reset: $reset_count"
            echo "  - Estimated completion: $estimated_hours hours"
            echo "âš¡ ETL batch processors will handle the rest every 15 minutes"
          else
            echo "âŒ ETL task queue reset failed with HTTP $http_code"
            echo "Response: $response_body"
            exit 1
          fi
        
      - name: Report completion
        if: always()
        run: |
          echo "ğŸ“‹ Daily ETL starter completed at $(date)"
          echo "Status: ${{ job.status }}"
          echo "ğŸš€ ETL batch processors (every 15min) will now handle data updates"