name: ETL Daily Starter (Reset Task Queue)

on:
  schedule:
    # ç¾ä¸œæ—¶é—´å‘¨ä¸€åˆ°å‘¨äº”æ—©ä¸Š9:25 AM (å¼€ç›˜å‰5åˆ†é’Ÿ) - å¯åŠ¨ETL
    # ä½¿ç”¨UTC 13:25 (å¤§éƒ¨åˆ†æ—¶é—´é€‚ç”¨ï¼ŒåŒ…æ‹¬å¤ä»¤æ—¶)
    - cron: '25 13 * * 1-5'  # å¯åŠ¨ETLä»»åŠ¡é˜Ÿåˆ—
    # ç¾ä¸œæ—¶é—´å‘¨ä¸€åˆ°å‘¨äº”ä¸‹åˆ4:05 PM (æ”¶ç›˜å5åˆ†é’Ÿ) - åœæ­¢ETL  
    # ä½¿ç”¨UTC 20:05 (å¤§éƒ¨åˆ†æ—¶é—´é€‚ç”¨ï¼ŒåŒ…æ‹¬å¤ä»¤æ—¶)
    - cron: '5 20 * * 1-5'   # åœæ­¢ETLä»»åŠ¡é˜Ÿåˆ—
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      action:
        description: 'ETL Action'
        required: true
        default: 'start'
        type: choice
        options:
          - 'start'
          - 'stop'

jobs:
  manage-daily-etl:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # 5åˆ†é’Ÿè¶…æ—¶
    
    steps:
      - name: Determine ETL Action
        id: determine-action
        run: |
          # ç¡®å®šæ‰§è¡Œçš„æ“ä½œï¼ˆå¯åŠ¨æˆ–åœæ­¢ï¼‰
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            action="${{ github.event.inputs.action }}"
          else
            # æ ¹æ®cronæ—¶é—´åˆ¤æ–­æ“ä½œ
            current_hour=$(date -u +%H)
            current_minute=$(date -u +%M)
            
            # å¯åŠ¨æ—¶é—´: 13:25 (ç¾ä¸œæ—¶é—´9:25 AM)
            if [ "$current_hour" = "13" ] && [ "$current_minute" = "25" ]; then
              action="start"
            # åœæ­¢æ—¶é—´: 20:05 (ç¾ä¸œæ—¶é—´4:05 PM)
            elif [ "$current_hour" = "20" ] && [ "$current_minute" = "05" ]; then
              action="stop"
            else
              # å¦‚æœä¸åœ¨é¢„å®šæ—¶é—´ï¼Œæ ¹æ®å½“å‰æ—¶é—´åˆ¤æ–­åº”è¯¥å¯åŠ¨è¿˜æ˜¯åœæ­¢
              # 13:25-20:05ä¹‹é—´åº”è¯¥æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œå…¶ä»–æ—¶é—´åº”è¯¥åœæ­¢
              if [ "$current_hour" -gt 13 ] || ([ "$current_hour" -eq 13 ] && [ "$current_minute" -ge 25 ]); then
                if [ "$current_hour" -lt 20 ] || ([ "$current_hour" -eq 20 ] && [ "$current_minute" -lt 5 ]); then
                  action="start"  # äº¤æ˜“æ—¶é—´å†…
                else
                  action="stop"   # äº¤æ˜“æ—¶é—´å¤–
                fi
              else
                action="stop"     # äº¤æ˜“æ—¶é—´å¤–
              fi
            fi
          fi
          
          echo "action=$action" >> $GITHUB_OUTPUT
          echo "ğŸ¯ ETL Action determined: $action"
          echo "â° Current UTC time: $(date -u '+%H:%M on %Y-%m-%d')"
          echo "ğŸ• Corresponding ET time: approximately $(date -d '-4 hours' '+%H:%M on %Y-%m-%d') (may vary with DST)"
      
      - name: Execute ETL Action
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          API_SECRET: ${{ secrets.API_SECRET }}
          VERCEL_DOMAIN: ${{ secrets.VERCEL_DOMAIN }}
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
        run: |
          action="${{ steps.determine-action.outputs.action }}"
          
          if [ "$action" = "start" ]; then
            echo "ğŸ”„ Starting daily ETL process at $(date)"
            echo "ğŸ“‹ Resetting task queue for all stocks..."
            endpoint="start"
            success_msg="âœ… ETL task queue reset successfully"
            failure_msg="âŒ ETL task queue reset failed"
          else
            echo "ğŸ›‘ Stopping daily ETL process at $(date)"
            echo "ğŸ“‹ Terminating active ETL tasks..."
            endpoint="stop"
            success_msg="âœ… ETL processes stopped successfully"
            failure_msg="âŒ ETL stop process failed"
          fi
          
          # è°ƒç”¨ç›¸åº”çš„ETL APIç«¯ç‚¹
          # æ„å»ºAPI URL - æ”¯æŒå¤šç§åŸŸåé…ç½®
          if [ -n "$VERCEL_DOMAIN" ]; then
            api_url="https://$VERCEL_DOMAIN/api/etl/$endpoint"
          elif [ -n "$VERCEL_URL" ]; then
            api_url="$VERCEL_URL/api/etl/$endpoint"
          else
            echo "âŒ Error: Neither VERCEL_DOMAIN nor VERCEL_URL is configured in secrets"
            exit 1
          fi
          
          echo "ğŸŒ Calling API: $api_url"
          
          # æ‰§è¡ŒAPIè°ƒç”¨ - ä½¿ç”¨æ­£ç¡®çš„ç¯å¢ƒå˜é‡å¼•ç”¨
          if [ -n "$CRON_SECRET" ]; then
            echo "ğŸ” Using CRON_SECRET for authentication"
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $CRON_SECRET" \
              "$api_url")
          elif [ -n "$API_SECRET" ]; then
            echo "ğŸ” Using API_SECRET for authentication"
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_SECRET" \
              "$api_url")
          else
            echo "âš ï¸ Warning: No authentication secret found, proceeding without auth"
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              "$api_url")
          fi
          
          # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | head -n -1)
          
          echo "ğŸ“Š API Response (HTTP $http_code):"
          echo "$response_body" | jq '.' 2>/dev/null || echo "$response_body"
          
          # æ£€æŸ¥HTTPçŠ¶æ€ç 
          if [ "$http_code" -eq 200 ]; then
            echo "$success_msg"
            
            if [ "$action" = "start" ]; then
              # è§£æå¯åŠ¨å“åº”
              reset_count=$(echo "$response_body" | jq -r '.data.resetCount // "N/A"')
              estimated_minutes=$(echo "$response_body" | jq -r '.data.estimatedMinutes // "N/A"')
              
              echo "ğŸ“ˆ Start Stats:"
              echo "  - Stocks reset: $reset_count"
              echo "  - Estimated completion: $estimated_minutes minutes"
              echo "âš¡ ETL batch processors will handle updates every 15 minutes"
              echo "ğŸ• ETL will automatically stop at market close (4:05 PM ET)"
            else
              # è§£æåœæ­¢å“åº”
              stopped_count=$(echo "$response_body" | jq -r '.data.stoppedCount // "N/A"')
              completed_today=$(echo "$response_body" | jq -r '.data.completedToday // "N/A"')
              failed_today=$(echo "$response_body" | jq -r '.data.failedToday // "N/A"')
              total_tasks=$(echo "$response_body" | jq -r '.data.totalTasks // "N/A"')
              
              echo "ğŸ“ˆ Stop Stats:"
              echo "  - Active tasks stopped: $stopped_count"
              echo "  - Tasks completed today: $completed_today"
              echo "  - Tasks failed today: $failed_today"
              echo "  - Total tasks today: $total_tasks"
              echo "ğŸ’° Cost savings: ~60% compared to 24/7 operation"
            fi
          else
            echo "$failure_msg with HTTP $http_code"
            echo "Response: $response_body"
            exit 1
          fi
        
      - name: Report completion
        if: always()
        run: |
          action="${{ steps.determine-action.outputs.action }}"
          echo "ğŸ“‹ Daily ETL management completed at $(date)"
          echo "Action: $action"
          echo "Status: ${{ job.status }}"
          
          if [ "$action" = "start" ]; then
            echo "ğŸš€ ETL batch processors (every 15min) will now handle data updates until market close"
            echo "â° Next automatic stop: 4:05 PM ET (æ”¶ç›˜å5åˆ†é’Ÿ)"
          else
            echo "ğŸ›‘ ETL processes have been stopped for the day"
            echo "â° Next automatic start: 9:25 AM ET tomorrow (å¼€ç›˜å‰5åˆ†é’Ÿ)"
          fi