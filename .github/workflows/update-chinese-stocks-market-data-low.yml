name: Update Chinese Stocks Market Data (Low Frequency)

on:
  schedule:
    # ä¸­æ¦‚è‚¡ä½é¢‘æ›´æ–° - æ·±å¤œæ—¶æ®µè¿è¡Œï¼Œå®Œå…¨é¿å¼€äº¤æ˜“æ—¶æ®µ
    # æ¯æ—¥æ•°æ®æ›´æ–°ï¼ˆUTC 09:00ï¼‰- ç¾ä¸œæ—¶é—´ 5:00 AMï¼Œè¿œç¦»äº¤æ˜“æ—¶æ®µ
    - cron: '0 9 * * 1-6'  # å‘¨ä¸€è‡³å‘¨å…­ï¼ˆåŒ…å«å‘¨äº”å¤œç›˜åï¼‰
    # æ¯å‘¨æ·±åº¦æ•°æ®æ›´æ–°ï¼ˆUTC 10:00 å‘¨æ—¥ï¼‰- ç¾ä¸œæ—¶é—´å‘¨æ—¥ 6:00 AM
    - cron: '0 10 * * 0'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      update_type:
        description: 'Update type'
        required: false
        default: 'daily'
        type: choice
        options:
          - 'daily'
          - 'weekly'
          - 'full'

# é˜²æ­¢å¹¶å‘æ‰§è¡Œ
concurrency:
  group: chinese-stocks-market-data-update-low
  cancel-in-progress: false

jobs:
  update-chinese-stocks-market-data-low:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Health check - Verify API and DB connectivity
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          echo "ğŸ” Checking Finnhub API connectivity..."
          curl -f "https://finnhub.io/api/v1/quote?symbol=BABA&token=$FINNHUB_API_KEY" || exit 1
          echo "âœ… Finnhub API is accessible"
          
      - name: Determine update type
        id: update_type
        run: |
          if [ "${{ github.event.schedule }}" = "0 6 * * 0" ]; then
            echo "type=weekly" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.update_type }}" != "" ]; then
            echo "type=${{ github.event.inputs.update_type }}" >> $GITHUB_OUTPUT
          else
            echo "type=daily" >> $GITHUB_OUTPUT
          fi
          
      - name: Run daily Chinese stocks data update
        if: steps.update_type.outputs.type == 'daily'
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          DEBUG: ${{ github.event.inputs.debug || 'false' }}
          MARKET_TYPE: chinese_stocks
          UPDATE_FREQUENCY: daily
        run: |
          echo "ğŸŒ… Starting Chinese stocks daily update..."
          echo "ğŸ“Š Expected runtime: 6-8 minutes for Chinese stocks"
          node _scripts/update-market-data-finnhub.mjs
          
      - name: Run weekly Chinese stocks comprehensive update
        if: steps.update_type.outputs.type == 'weekly' || steps.update_type.outputs.type == 'full'
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          DEBUG: ${{ github.event.inputs.debug || 'false' }}
          MARKET_TYPE: chinese_stocks
          UPDATE_FREQUENCY: weekly
        run: |
          echo "ğŸ“… Starting Chinese stocks weekly comprehensive update..."
          echo "ğŸ“Š Expected runtime: 15-20 minutes for Chinese stocks"
          
          # 1. æ›´æ–°å¸‚åœºæ•°æ®
          echo "ğŸ“ˆ Step 1: Updating market data..."
          node _scripts/update-market-data-finnhub.mjs
          
          # 2. æ›´æ–°å…¬å¸èµ„æ–™
          echo "ğŸ¢ Step 2: Updating company profiles..."
          node _scripts/update-company-profiles.mjs
          
          # 3. æ›´æ–°è´¢åŠ¡æ•°æ®
          echo "ğŸ’° Step 3: Updating financial data..."
          node _scripts/update-financials-daily.mjs
          
          # 4. æ›´æ–°æ ‡ç­¾åˆ†é…
          echo "ğŸ·ï¸ Step 4: Updating tag assignments..."
          node _scripts/comprehensive-tag-assignment.js
          
      - name: Data completeness check
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          MARKET_TYPE: chinese_stocks
        run: |
          echo "ğŸ” Running data completeness check..."
          node _scripts/check-data-completeness.mjs
          
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: chinese-stocks-market-update-low-logs
          path: |
            /home/runner/work/Stock-Tag-Explorer-01/Stock-Tag-Explorer-01/*.log
          retention-days: 7
          
      - name: Notify completion
        if: success() && (steps.update_type.outputs.type == 'weekly' || steps.update_type.outputs.type == 'full')
        run: |
          echo "âœ… Chinese stocks weekly update completed successfully"
          echo "ğŸ“Š All data sources updated and validated"