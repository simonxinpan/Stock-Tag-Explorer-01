name: ETL Smart Batch Processor

on:
  schedule:
    # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œä½†åªåœ¨äº¤æ˜“æ—¶é—´å†…è¿è¡Œ
    # ç¾ä¸œæ—¶é—´å‘¨ä¸€åˆ°å‘¨äº” 9:30 AM - 4:00 PM (UTC 13:30-20:00)
    - cron: '*/15 13-19 * * 1-5'  # äº¤æ˜“æ—¶é—´å†…æ¯15åˆ†é’Ÿ
    - cron: '0 20 * * 1-5'        # æ”¶ç›˜æ—¶æœ€åä¸€æ¬¡è¿è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_run:
        description: 'Force run outside trading hours'
        required: false
        default: 'false'
        type: boolean

jobs:
  etl-batch-process:
    runs-on: ubuntu-latest
    timeout-minutes: 170  # 170åˆ†é’Ÿè¶…æ—¶ï¼Œç¡®ä¿160åˆ†é’Ÿè¿è¡Œæ—¶é—´é™åˆ¶æœ‰ç¼“å†²
    
    steps:
      - name: Check Trading Hours
        id: check-trading-hours
        run: |
          # æ£€æŸ¥æ˜¯å¦åœ¨äº¤æ˜“æ—¶é—´å†…æˆ–å¼ºåˆ¶è¿è¡Œ
          force_run="${{ github.event.inputs.force_run || 'false' }}"
          
          if [ "$force_run" = "true" ]; then
            echo "ğŸ”§ Force run enabled - bypassing trading hours check"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # è·å–å½“å‰UTCæ—¶é—´
          current_hour=$(date -u +%H)
          current_minute=$(date -u +%M)
          current_day=$(date -u +%u)  # 1=Monday, 7=Sunday
          
          echo "â° Current UTC time: $(date -u '+%H:%M on %Y-%m-%d (day %u)')"
          echo "ğŸ• Approximate ET time: $(date -d '-4 hours' '+%H:%M on %Y-%m-%d') (may vary with DST)"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºå·¥ä½œæ—¥ (Monday=1 to Friday=5)
          if [ "$current_day" -gt 5 ]; then
            echo "ğŸ“… Weekend detected - skipping ETL batch processing"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥æ˜¯å¦åœ¨äº¤æ˜“æ—¶é—´å†… (UTC 13:30-20:00 approximately ET 9:30-16:00)
          trading_start_hour=13
          trading_start_minute=30
          trading_end_hour=20
          trading_end_minute=0
          
          # è½¬æ¢å½“å‰æ—¶é—´ä¸ºåˆ†é’Ÿæ•°ä¾¿äºæ¯”è¾ƒ
          current_minutes=$((current_hour * 60 + current_minute))
          trading_start_minutes=$((trading_start_hour * 60 + trading_start_minute))
          trading_end_minutes=$((trading_end_hour * 60 + trading_end_minute))
          
          if [ "$current_minutes" -ge "$trading_start_minutes" ] && [ "$current_minutes" -le "$trading_end_minutes" ]; then
            echo "ğŸ“ˆ Within trading hours - proceeding with ETL batch processing"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸŒ™ Outside trading hours - skipping ETL batch processing"
            echo "ğŸ’° This saves approximately 60% of database costs"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Checkout repository
        if: steps.check-trading-hours.outputs.should_run == 'true'
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        if: steps.check-trading-hours.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        if: steps.check-trading-hours.outputs.should_run == 'true'
        run: npm ci
        
      - name: Run ETL Batch Process
        if: steps.check-trading-hours.outputs.should_run == 'true'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          echo "ğŸš€ Starting ETL Smart Batch Processor at $(date)"
          echo "ğŸ“‹ Processing stocks with 160-minute runtime limit..."
          echo "â±ï¸ Each batch: 50 stocks, 13-second delay (Polygon API limit)"
          
          # è¿è¡Œæ™ºèƒ½åˆ†æ‰¹å¤„ç†å™¨ï¼Œ160åˆ†é’Ÿè¿è¡Œæ—¶é—´é™åˆ¶
          node _scripts/etl-smart-batch-processor.mjs
          
          echo "âœ… ETL Smart Batch Processor completed at $(date)"
          
      - name: Report completion
        if: always()
        run: |
          should_run="${{ steps.check-trading-hours.outputs.should_run }}"
          
          echo "ğŸ“‹ ETL Smart Batch Processor job completed at $(date)"
          echo "Status: ${{ job.status }}"
          
          if [ "$should_run" = "true" ]; then
            echo "â° Runtime Limit: 160 minutes per execution"
            echo "ğŸ“ˆ Executed during trading hours"
            
            # å¦‚æœå¤±è´¥ï¼Œè¾“å‡ºè°ƒè¯•ä¿¡æ¯
            if [ "${{ job.status }}" != "success" ]; then
              echo "ğŸ” Debug Info:"
              echo "  - Workflow: ${{ github.workflow }}"
              echo "  - Run ID: ${{ github.run_id }}"
              echo "  - Check logs above for detailed error information"
            fi
          else
            echo "ğŸŒ™ Skipped - outside trading hours"
            echo "ğŸ’° Cost savings: ~60% compared to 24/7 operation"
            echo "â° Next run: during trading hours (ET 9:30 AM - 4:00 PM, Mon-Fri)"
          fi