name: Update Chinese Stocks Market Data (High Frequency)

on:
  schedule:
    # ä¸­æ¦‚è‚¡é«˜é¢‘æ›´æ–° - äº¤é”™è°ƒåº¦ç¬¬2ã€4è½®ï¼ˆUTC 13:30-20:00ï¼Œå‘¨ä¸€è‡³å‘¨äº”ï¼‰
    # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œä¸æ ‡æ™®500é”™å¼€7.5åˆ†é’Ÿï¼Œé¿å…APIé™åˆ¶å†²çª
    # 193åªè‚¡ç¥¨ï¼Œ5æ¬¡è¿è¡Œï¼Œæ¯æ¬¡çº¦75åˆ†é’Ÿï¼Œæ€»è®¡çº¦4å°æ—¶ä¸æ ‡æ™®500äº¤é”™
    - cron: '37,52 13-19 * * 1-5'  # æ¯å°æ—¶çš„37åˆ†å’Œ52åˆ†æ‰§è¡Œï¼ˆé”™å¼€7åˆ†é’Ÿï¼‰
    - cron: '7,22 14-19 * * 1-5'   # æ¯å°æ—¶çš„7åˆ†å’Œ22åˆ†æ‰§è¡Œï¼ˆé”™å¼€7åˆ†é’Ÿï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_run:
        description: 'Force run outside trading hours'
        required: false
        default: 'false'
        type: boolean

# é˜²æ­¢å¹¶å‘æ‰§è¡Œï¼Œé¿å…æ•°æ®åº“å†²çªå’ŒAPIé™åˆ¶é—®é¢˜
concurrency:
  group: chinese-stocks-market-data-update
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œè€Œæ˜¯ç­‰å¾…å®Œæˆ

jobs:
  chinese-stocks-etl-batch-process:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # 15åˆ†é’Ÿè¶…æ—¶ï¼Œç¡®ä¿11åˆ†é’Ÿè¿è¡Œæ—¶é—´é™åˆ¶æœ‰ç¼“å†²
    
    
    steps:
      - name: Check Trading Hours
        id: check-trading-hours
        run: |
          # æ£€æŸ¥æ˜¯å¦åœ¨äº¤æ˜“æ—¶é—´å†…æˆ–å¼ºåˆ¶è¿è¡Œ
          force_run="${{ github.event.inputs.force_run || 'false' }}"
          
          if [ "$force_run" = "true" ]; then
            echo "ğŸ”§ Force run enabled - bypassing trading hours check"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # è·å–å½“å‰UTCæ—¶é—´
          current_hour=$(date -u +%H)
          current_minute=$(date -u +%M)
          current_day=$(date -u +%u)  # 1=Monday, 7=Sunday
          
          echo "â° Current UTC time: $(date -u '+%H:%M on %Y-%m-%d (day %u)')"
          echo "ğŸ• Approximate ET time: $(date -d '-4 hours' '+%H:%M on %Y-%m-%d') (may vary with DST)"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºå·¥ä½œæ—¥ (Monday=1 to Friday=5)
          if [ "$current_day" -gt 5 ]; then
            echo "ğŸ“… Weekend detected - skipping Chinese stocks ETL batch processing"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥æ˜¯å¦åœ¨äº¤æ˜“æ—¶é—´å†… (UTC 13:30-20:00 approximately ET 9:30-16:00)
          trading_start_hour=13
          trading_start_minute=30
          trading_end_hour=20
          trading_end_minute=0
          
          # è½¬æ¢å½“å‰æ—¶é—´ä¸ºåˆ†é’Ÿæ•°ä¾¿äºæ¯”è¾ƒ
          current_minutes=$((current_hour * 60 + current_minute))
          trading_start_minutes=$((trading_start_hour * 60 + trading_start_minute))
          trading_end_minutes=$((trading_end_hour * 60 + trading_end_minute))
          
          if [ "$current_minutes" -ge "$trading_start_minutes" ] && [ "$current_minutes" -le "$trading_end_minutes" ]; then
            echo "ğŸ“ˆ Within trading hours - proceeding with Chinese stocks ETL batch processing"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸŒ™ Outside trading hours - skipping Chinese stocks ETL batch processing"
            echo "ğŸ’° This saves approximately 60% of database costs"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Checkout repository
        if: steps.check-trading-hours.outputs.should_run == 'true'
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        if: steps.check-trading-hours.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        if: steps.check-trading-hours.outputs.should_run == 'true'
        run: npm ci
        
      - name: Run Chinese Stocks ETL Batch Process
        if: steps.check-trading-hours.outputs.should_run == 'true'
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          BATCH_SIZE: 50
          DELAY_SECONDS: 13
          MAX_RUNTIME_MINUTES: 11
        run: |
          echo "ğŸš€ Starting Chinese Stocks ETL Smart Batch Processor at $(date)"
          echo "ğŸ“‹ Processing Chinese stocks with 11-minute runtime limit..."
          echo "â±ï¸ Each batch: 50 stocks, 13-second delay (Polygon API limit)"
          
          # è¿è¡Œä¸­æ¦‚è‚¡æ™ºèƒ½åˆ†æ‰¹å¤„ç†å™¨ï¼Œæ¯æ¬¡å¤„ç†1æ‰¹50åªè‚¡ç¥¨ï¼Œ11åˆ†é’Ÿè¿è¡Œæ—¶é—´é™åˆ¶ï¼ˆåƒç´ çº§æ¨¡ä»¿æ ‡æ™®500ï¼‰
          node _scripts/etl-chinese-stocks-batch-processor.mjs
          
          echo "âœ… Chinese Stocks ETL Smart Batch Processor completed at $(date)"
          
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: chinese-stocks-etl-batch-logs
          path: |
            /home/runner/work/Stock-Tag-Explorer-01/Stock-Tag-Explorer-01/*.log
          retention-days: 7