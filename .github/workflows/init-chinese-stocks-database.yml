name: Initialize Chinese Stocks Database

on:
  workflow_dispatch:  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_recreate:
        description: 'Force recreate database tables (DANGER: will delete existing data)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      initial_data_load:
        description: 'Load initial stock data after database creation'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# é˜²æ­¢å¹¶å‘æ‰§è¡Œï¼Œé¿å…æ•°æ®åº“å†²çª
concurrency:
  group: chinese-stocks-database-init
  cancel-in-progress: false

jobs:
  init-chinese-stocks-database:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # åˆå§‹åŒ–å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Verify environment variables
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          echo "ğŸ” Verifying environment variables..."
          if [ -z "$CHINESE_STOCKS_DATABASE_URL" ]; then
            echo "âŒ CHINESE_STOCKS_DATABASE_URL is not set"
            exit 1
          fi
          if [ -z "$FINNHUB_API_KEY" ]; then
            echo "âŒ FINNHUB_API_KEY is not set"
            exit 1
          fi
          echo "âœ… All required environment variables are set"
          
      - name: Test database connectivity
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
        run: |
          echo "ğŸ”— Testing database connectivity..."
          node -e "
            const { Pool } = require('pg');
            const pool = new Pool({ 
              connectionString: process.env.CHINESE_STOCKS_DATABASE_URL, 
              ssl: { rejectUnauthorized: false } 
            });
            pool.query('SELECT NOW()').then(() => {
              console.log('âœ… Database connection successful');
              process.exit(0);
            }).catch(err => {
              console.error('âŒ Database connection failed:', err.message);
              process.exit(1);
            });
          "
          
      - name: Initialize Chinese stocks database structure
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          FORCE_RECREATE: ${{ github.event.inputs.force_recreate || 'false' }}
          DEBUG: ${{ github.event.inputs.debug || 'false' }}
        run: |
          echo "ğŸ—ï¸ Initializing Chinese stocks database structure..."
          if [ "$FORCE_RECREATE" = "true" ]; then
            echo "âš ï¸ WARNING: Force recreate mode enabled - existing data will be deleted!"
            sleep 5
          fi
          node _scripts/init-chinese-stocks-db.mjs
          
      - name: Load initial Chinese stocks data
        if: github.event.inputs.initial_data_load != 'false'
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          DEBUG: ${{ github.event.inputs.debug || 'false' }}
          MARKET_TYPE: chinese_stocks
          INITIAL_LOAD: 'true'
        run: |
          echo "ğŸ“Š Loading initial Chinese stocks data..."
          echo "â±ï¸ Expected runtime: 20-25 minutes for full initial load"
          echo "ğŸ“ˆ This includes: stock list, basic data, company profiles"
          
          # 1. è·å–ä¸­æ¦‚è‚¡åˆ—è¡¨å¹¶åˆ›å»ºåŸºç¡€è®°å½•
          echo "ğŸ“‹ Step 1: Loading Chinese stocks list..."
          node _scripts/update-market-data-finnhub.mjs
          
          # ç­‰å¾…APIé™åˆ¶é‡ç½®
          echo "â³ Waiting 60 seconds for API rate limit reset..."
          sleep 60
          
          # 2. æ›´æ–°å…¬å¸èµ„æ–™
          echo "ğŸ¢ Step 2: Loading company profiles..."
          node _scripts/update-company-profiles.mjs
          
          # ç­‰å¾…APIé™åˆ¶é‡ç½®
          echo "â³ Waiting 60 seconds for API rate limit reset..."
          sleep 60
          
          # 3. åˆå§‹è´¢åŠ¡æ•°æ®
          echo "ğŸ’° Step 3: Loading initial financial data..."
          node _scripts/update-financials-daily.mjs
          
      - name: Verify data completeness
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
          MARKET_TYPE: chinese_stocks
        run: |
          echo "ğŸ” Verifying data completeness..."
          node _scripts/check-data-completeness.mjs
          
      - name: Generate initialization report
        env:
          CHINESE_STOCKS_DATABASE_URL: ${{ secrets.CHINESE_STOCKS_DATABASE_URL }}
        run: |
          echo "ğŸ“‹ Generating initialization report..."
          node -e "
            const { Pool } = require('pg');
            const pool = new Pool({ 
              connectionString: process.env.CHINESE_STOCKS_DATABASE_URL, 
              ssl: { rejectUnauthorized: false } 
            });
            
            async function generateReport() {
              try {
                const stocksCount = await pool.query('SELECT COUNT(*) FROM stocks');
                const companiesCount = await pool.query('SELECT COUNT(*) FROM companies WHERE symbol IS NOT NULL');
                const financialsCount = await pool.query('SELECT COUNT(*) FROM financials');
                
                console.log('\nğŸ“Š Chinese Stocks Database Initialization Report');
                console.log('================================================');
                console.log('ğŸ“ˆ Total stocks:', stocksCount.rows[0].count);
                console.log('ğŸ¢ Companies with profiles:', companiesCount.rows[0].count);
                console.log('ğŸ’° Financial records:', financialsCount.rows[0].count);
                console.log('âœ… Database initialization completed successfully!');
                
                await pool.end();
              } catch (error) {
                console.error('âŒ Error generating report:', error.message);
                process.exit(1);
              }
            }
            
            generateReport();
          "
          
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: chinese-stocks-database-init-logs
          path: |
            /home/runner/work/Stock-Tag-Explorer-01/Stock-Tag-Explorer-01/*.log
          retention-days: 14  # ä¿ç•™æ›´é•¿æ—¶é—´ç”¨äºè°ƒè¯•
          
      - name: Success notification
        if: success()
        run: |
          echo "ğŸ‰ Chinese stocks database initialization completed successfully!"
          echo "ğŸ“Š Database is ready for regular data updates"
          echo "ğŸš€ You can now run the regular update workflows"